<!DOCTYPE html><!--
Copyright 2021 James Deery
Released under the MIT licence, https://opensource.org/licenses/MIT
--><html lang="en"><head><title>M8 Display</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="theme-color" content="#000"><link rel="shortcut icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAABlBMVEUAAAAA7/9Rg7lhAAAAHElEQVQI12NgQAJKNQxmLgxaLiCGkgsY1TCgAgBaqAOPApktdwAAAABJRU5ErkJggg=="><link rel="apple-touch-icon" href="icon.png"><link rel="manifest" href="app.webmanifest"><style>
@font-face{font-family:"stealth57";src:url("data:font/woff2;base64,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") format("woff2")}body{font-family:sans-serif;background-color:#000;color:#eee;margin:0px;font-size:16px}a,a:visited{color:#00efff;text-decoration:none}a:hover,a:visited:hover{text-decoration:underline}a:focus,a:visited:focus{outline:1px solid #00efff}.hidden{display:none}label,input,select,button{appearance:none;font-family:"stealth57";font-size:14px;background-color:#000;color:#fff}label:hover,input:hover,select:hover,button:hover{background-color:#00efff;color:#000}label:active,input:active,select:active,button:active{background-color:#00bfcc;color:#fff}label:focus,label:focus-within,input:focus,input:focus-within,select:focus,select:focus-within,button:focus,button:focus-within{outline:none;color:#00efff}label:focus:hover,label:focus-within:hover,input:focus:hover,input:focus-within:hover,select:focus:hover,select:focus-within:hover,button:focus:hover,button:focus-within:hover{color:#000}label:focus:active,label:focus-within:active,input:focus:active,input:focus-within:active,select:focus:active,select:focus-within:active,button:focus:active,button:focus-within:active{color:#fff}button{border:3px solid #fff;padding:20px}input[type=checkbox]{font-family:"stealth57"}input[type=checkbox]::after{content:"OFF"}input[type=checkbox]:checked::after{content:"ON"}input[type=file]{border:3px solid #fff;padding:20px}select{padding:5px 32px 5px 5px;background-color:transparent;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23fff' stroke-width='3' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right 10px center;background-size:16px;font-family:sans-serif;font-size:12px}progress{border:3px solid #fff;height:40px;width:100%}progress::-webkit-progress-bar{background-color:#000}progress::-webkit-progress-value{background-color:#00efff}#display{position:relative;width:100vw;height:75vw;max-width:133.3333333333vh;max-height:100vh;margin:0 auto;top:0;bottom:0;left:0;right:0;user-select:none}#display canvas,#display svg{position:absolute;width:100%;height:100%}#display canvas{image-rendering:pixelated}#display svg text{font-family:"stealth57";font-size:16px}#display #buttons{position:absolute;top:25px;width:100%;text-align:center}body.mapping #display #buttons{display:none}#display #mapping-buttons{display:none;position:absolute;top:25px;width:100%;text-align:center}body.mapping #display #mapping-buttons{display:block}#display #mapping-buttons button{margin:0 5px 10px}#display.with-controls,body.mapping #display{height:150vw;max-width:66.6666666667vh}#display.with-controls canvas,#display.with-controls svg,body.mapping #display canvas,body.mapping #display svg{height:50%}#display.with-controls #controls,body.mapping #display #controls{display:block}#display #controls{display:none;position:relative;width:100%;height:50%;top:50%}#display #controls>div{position:absolute;width:20.3125%;height:27.0833%;border:3px solid #aaa;border-radius:10px;background-color:#333;box-sizing:border-box;padding:5px;text-align:center;font-size:80%}#display #controls>div.active{border-color:#00efff}#display #controls>div.mapping{border-color:#e30;z-index:1001}#display #mapping-help{display:none;position:absolute;bottom:50%;width:100%;font-family:"stealth57";text-align:center}body.mapping #display #mapping-help{display:block}body.mapping #display #mapping-help .select-action{display:block}body.mapping #display #mapping-help .enter-input{display:none}body.mapping.capturing #display #mapping-help .select-action{display:none}body.mapping.capturing #display #mapping-help .enter-input{display:block;position:relative;z-index:1001}#capture-shield{display:none;position:fixed;top:0;bottom:0;left:0;right:0;background-color:rgba(0,0,0,.75);z-index:1000}body.mapping.capturing #capture-shield{display:block}#settings{position:fixed;top:0;bottom:0;left:0;right:0;background-color:rgba(0,0,0,.5);transition:background-color 80ms linear 0s;user-select:none}#settings.hidden{display:block;width:0;height:0;background-color:rgba(0,0,0,0)}#settings.hidden .setting{visibility:hidden;margin-left:-323px;transition:none}#settings.hidden #menu-button{background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23fff' stroke-width='1.5' d='M2 4h12M2 8h12M2 12h12'/%3e%3c/svg%3e")}#settings.hidden.auto-hide #menu-button{opacity:0%;transition:opacity .8s linear .8s}#settings.hidden.auto-hide #menu-button:hover,#settings.hidden.auto-hide #menu-button:focus{opacity:100%;transition:opacity 0s}#settings #menu-button{width:32px;height:32px;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23fff' stroke-width='1.5' d='M3 3l10 10M3 13l10-10'/%3e%3c/svg%3e");background-repeat:no-repeat;background-color:transparent;border-color:transparent;font-size:0;margin-bottom:-3px}#settings #menu-button:hover{background-color:#00efff}#settings #menu-button:active{background-color:#00bfcc;color:#fff}#settings #menu-button:focus{color:#00efff;border-color:#00efff}#settings #menu-button:focus:hover{color:#000}#settings #menu-button:focus:active{color:#fff}#settings .setting{width:320px;border:3px solid #fff;border-width:3px 3px 0 0;margin-left:0;transition:margin-left 80ms linear 0s}#settings .setting:last-child{border-bottom-width:3px}#settings .setting label{display:block;position:relative;padding:10px}#settings .setting label input,#settings .setting label select{position:absolute;top:0;bottom:0;right:0;margin:0;border:0}#settings .setting label input[type=checkbox]{padding:10px}#settings .setting label select{width:50%}#settings .setting button{display:block;width:100%;margin:0;border:0;padding:10px}#firmware{position:fixed;top:0;bottom:0;left:0;right:0;padding:100px;background-color:rgba(0,0,0,.75);text-align:center;font-family:"stealth57";line-height:1.5}#firmware.hidden{display:none}#firmware p.select-file-msg,#firmware input[type=file],#firmware p.file-loading-msg,#firmware p.file-error-msg,#firmware p.select-device-msg,#firmware button.select-device,#firmware p.device-error-msg,#firmware p.flash-msg,#firmware button.flash,#firmware p.flashing-msg,#firmware progress.flash,#firmware p.flash-error-msg,#firmware p.flash-success-msg{display:none;margin:20px auto}#firmware p.file-error-msg,#firmware p.device-error-msg,#firmware p.flash-error-msg{color:#e22}#firmware.file-select p.select-file-msg,#firmware.file-select input[type=file]{display:block}#firmware.file-loading p.file-loading-msg{display:block}#firmware.file-loading button.close{display:none}#firmware.file-error p.select-file-msg,#firmware.file-error input[type=file],#firmware.file-error p.file-error-msg{display:block}#firmware.file-loaded p.select-device-msg,#firmware.file-loaded button.select-device{display:block}#firmware.device-error p.select-device-msg,#firmware.device-error button.select-device,#firmware.device-error p.device-error-msg{display:block}#firmware.device-selected p.flash-msg,#firmware.device-selected button.flash{display:block}#firmware.flashing p.flashing-msg,#firmware.flashing progress.flash{display:block}#firmware.flashing button.close{display:none}#firmware.flash-error p.select-device-msg,#firmware.flash-error button.select-device,#firmware.flash-error p.flash-error-msg{display:block}#firmware.flash-success p.flash-success-msg{display:block}#firmware button.close{display:block;position:absolute;right:100px;bottom:100px}#info{position:absolute;top:100px;left:100px;right:100px;padding:20px;background-color:rgba(0,0,0,.75);text-align:center;line-height:1.5}#info h1{font-family:"stealth57";font-size:32px;margin:0 0 16px}#info .warning{color:#e22}.error{position:absolute;top:100px;left:100px;right:100px;border:3px solid #fff;padding:20px;background-color:#a22;user-select:text}.error p{margin-top:0}.error p:last-child{margin-bottom:0}#reload{position:fixed;bottom:0;left:0;right:0;text-align:center}#reload button{border-bottom-width:0}

</style></head><body><div id="display"><canvas id="canvas" width="320" height="240"></canvas><div id="buttons" class="hidden"></div><div id="mapping-buttons"></div><div id="mapping-help"><p class="select-action">Click a key to add a new mapping</p><p class="enter-input">Press a keyboard key or gamepad button</p></div><div id="controls"><div data-action="edit" style="top: 2.0833%; left: 76.5625%"></div><div data-action="option" style="top: 2.0833%; left: 53.125%"></div><div data-action="up" style="top: 6.25%; left: 25%"></div><div data-action="left" style="top: 37.5%; left: 1.5625%"></div><div data-action="down" style="top: 37.5%; left: 25%"></div><div data-action="right" style="top: 37.5%; left: 48.4375%"></div><div data-action="select" style="top: 70.8333%; left: 27.3438%"></div><div data-action="start" style="top: 70.8333%; left: 50.7813%"></div></div></div><div id="serial-fail" class="error hidden"><p>Failed to connect over Serial.
Are you sure your Teensy is connected and the M8 Headless firmware is loaded?</p><p>Make sure that there are no other programs running which may have the serial port open.</p><p>On Linux you may also need make sure you have permission to open the serial port (eg. make yourself a member of the <code>dialout</code> group).</p><p>It is also possible there's a bug in this code.
There may be some messages in the developer console that will help with debugging.</p></div><div id="usb-fail" class="error hidden"><p>Failed to connect with WebUSB.
Are you sure your Teensy is connected and the M8 Headless firmware is loaded?</p><p>Connecting with WebUSB is known not to work on Windows or Linux.
If you are using Chrome you can use Serial instead but you need to enable an experimental flag by going to <code>chrome://flags</code> and enabling "Experimental Web Platform features".</p></div><div id="no-serial-usb" class="error hidden"><p>Your browser doesn't appear to have Serial or WebUSB support.
These are only currently supported in Chrome and some Chrome-derived browsers.</p></div><div id="info"><h1>M8 Display</h1><p class="warning">Work in progress, use at your own risk.</p><p>This is a display for the <a href="https://github.com/DirtyWave/M8HeadlessFirmware" target="_blank" rel="noopener">M8 Headless firmware</a> running on a Teensy 4.1, or a <a href="https://dirtywave.com/" target="_blank" rel="noopener">real M8 device</a>.
You can use keyboard and gamepad input or use on-screen controls.
Where possible, the audio output from the M8 is routed to your default audio output device.</p><p>Control mappings and other settings can be configured from the menu.
You can also install or update firmware.</p><p>Now that this page has loaded it will work completely offline.
All settings are stored locally by your browser.</p><p>Source code and more details are available at <a href="https://github.com/derkyjadex/M8WebDisplay" target="_blank" rel="noopener">github.com/derkyjadex/M8WebDisplay</a>.</p><button>OK</button></div><div id="settings" class="hidden"><button id="menu-button">Menu</button></div><div id="reload" class="hidden"><button>An update is available. Click to reload.</button></div><div id="capture-shield"></div><div id="firmware" class="hidden"><p class="select-file-msg">Select a firmware file</p><input type="file" accept=".hex"><p class="file-loading-msg">Loading file...</p><p class="file-error-msg">The selected file does not appear to be a valid Teensy 4.1 firmware file</p><p class="select-device-msg">Connect your Teensy board and press the little button on the board</p><button class="select-device">Select Teensy Device</button><p class="device-error-msg">The selected device does not appear to be a Teensy 4.1</p><p class="flash-msg">Ready to flash</p><button class="flash">Flash</button><p class="flashing-msg">Flashing...</p><progress class="flash"></progress><p class="flash-error-msg">There was an error flashing the device. You can try again.</p><p class="flash-success-msg">Flashing completed successfully</p><button class="close">Close</button></div><script>
function e(e){document.querySelectorAll(e).forEach((e=>e.classList.remove("hidden")))}function t(e){document.querySelectorAll(e).forEach((e=>e.classList.add("hidden")))}function r(e){return new Promise((t=>setTimeout(t,e)))}function a(e,t,r){const a=document.createElement("button");return a.innerText=t,n(a,"click",r),"string"==typeof e&&(e=document.querySelector(e)),e.append(a),a}function n(e,t,r){"string"==typeof e?e=document.querySelectorAll(e):e instanceof Array||(e=[e]);for(const a of e)a.addEventListener(t,r)}class o{_device;_parser;_onConnectionChanged;constructor(e,t){this._parser=e,this._onConnectionChanged=t}get isConnected(){return!!this._device}async _startReading(){try{for(;this._device;){const e=await this._device.transferIn(3,512);"ok"!==e.status?this.disconnect():this._parser.process(new Uint8Array(e.data.buffer))}}catch(e){console.error(e),this.disconnect()}}async sendKeys(e){if(this._device)try{await this._device.transferOut(3,new Uint8Array([67,e]))}catch(e){console.error(e),this.disconnect()}}async _reset(){await this._device.transferOut(3,new Uint8Array([68])),await r(50),this._parser.reset(),await this._device.transferOut(3,new Uint8Array([69,82]))}async disconnect(){const e=this._device;e&&(this._device=null,await e.close().catch((()=>{})),this._onConnectionChanged(!1))}async connect(){if(!this._device)try{const e=await navigator.usb.getDevices();this._device=e.filter((e=>5824===e.vendorId&&1162===e.productId))[0],this._device||(this._device=await navigator.usb.requestDevice({filters:[{vendorId:5824,productId:1162}]})),await this._device.open(),await this._device.selectConfiguration(1),await this._device.claimInterface(1),await this._device.controlTransferOut({requestType:"class",recipient:"interface",request:34,value:3,index:1}),await this._device.controlTransferOut({requestType:"class",recipient:"interface",request:32,value:0,index:1},new Uint8Array([128,37,0,0,0,0,8])),await this._reset(),this._startReading(),this._onConnectionChanged(!0)}catch(e){if(this.disconnect(e),e.code!==DOMException.NOT_FOUND_ERR)throw console.error(e),e}}deviceInfo(){const e=this._device.configuration.interfaces.flatMap((e=>e.alternates[0].endpoints.map((t=>({ifNum:e.interfaceNumber,class:e.alternates[0].interfaceClass,subClass:e.alternates[0].interfaceSubclass,protocol:e.alternates[0].interfaceProtocol,epNum:t.endpointNumber,epDir:t.direction,epType:t.type,epPacketSize:t.packetSize})))));console.table(e)}}class i{_port;_parser;_onConnectionChanged;_waitingForUserSelection;constructor(e,t){this._parser=e,this._onConnectionChanged=t,this._waitingForUserSelection=!1,navigator.serial.addEventListener("connect",(e=>{this._waitingForUserSelection||this.connect().catch((()=>{}))}))}get isConnected(){return!!this._port}async _startReading(){try{for(;this._port;){const{value:e,done:t}=await this._port.reader.read();if(e)try{this._parser.process(e)}catch(e){console.error(e)}if(t)return}}catch(e){console.error(e),this.disconnect()}}async sendKeys(e){if(this._port&&this._port.writer)try{await this._port.writer.write(new Uint8Array([67,e]))}catch(e){console.error(e),this.disconnect()}}async _reset(){await this._port.writer.write(new Uint8Array([68])),await r(50),this._parser.reset(),await this._port.writer.write(new Uint8Array([69,82]))}async disconnect(){const e=this._port;e&&(this._port=null,e.writer&&await e.writer.write(new Uint8Array([68])).catch((()=>{})),e.reader&&await e.reader.cancel().catch((()=>{})),await e.close().catch((()=>{})),this._onConnectionChanged(!1))}async connect(e=!1){if(!this._port)try{const t=await navigator.serial.getPorts();if(this._port=t.filter((e=>{const t=e.getInfo();return 5824===t.usbVendorId&&1162===t.usbProductId}))[0],this._port||(e?this._onConnectionChanged(!1):this._port=await this._requestPort()),!this._port)return;await this._port.open({baudRate:9600,dataBits:8,stopBits:1,parity:"none",bufferSize:512}),this._port.reader=await this._port.readable.getReader(),this._port.writer=await this._port.writable.getWriter(),await this._reset(),this._startReading(),this._onConnectionChanged(!0)}catch(e){throw console.error(e),this.disconnect(e),e}}async _requestPort(){this._waitingForUserSelection=!0;try{return await navigator.serial.requestPort({filters:[{usbVendorId:5824,usbProductId:1162}]})}catch(e){if(e.code!==DOMException.NOT_FOUND_ERR)throw e;return null}finally{this._waitingForUserSelection=!1}}}const s=Symbol("normal"),c=Symbol("escape"),l=Symbol("error");var d=Object.freeze({__proto__:null,blit_vert:"#version 300 es\nout vec2 srcCoord;const vec2 corners[]=vec2[](vec2(0,0),vec2(0,1),vec2(1,0),vec2(1,1));void main(){vec2 pos =corners[gl_VertexID]*vec2(2.0,2.0)+vec2(-1.0,-1.0);gl_Position =vec4(pos,0.0,1.0);srcCoord =corners[gl_VertexID]*vec2(320.0,240.0);}",rect_vert:"#version 300 es\nlayout(location =0)in vec4 shape;layout(location =1)in vec3 colour;out vec3 colourV;const vec2 corners[]=vec2[](vec2(0,0),vec2(0,1),vec2(1,0),vec2(1,1));const vec2 camScale =vec2(2.0 /320.0,-2.0 /240.0);const vec2 camOffset =vec2(-160.0,-120.0);void main(){vec2 pos =shape.xy;vec2 size =shape.zw;pos =((corners[gl_VertexID]*size +pos)+camOffset)*camScale;gl_Position =vec4(pos,0.0,1.0);colourV =colour;}",text_vert:"#version 300 es\nlayout(location =0)in vec3 colour;layout(location =1)in float char;out vec3 colourV;out vec2 fontCoord;const vec2 corners[]=vec2[](vec2(0,0),vec2(0,1),vec2(1,0),vec2(1,1));const vec2 camScale =vec2(2.0 /320.0,-2.0 /240.0);const vec2 camOffset =vec2(-160.0,-120.0);const vec2 size =vec2(5.0,7.0);void main(){float row;float col =modf(float(gl_InstanceID)/40.0,row)*40.0;vec2 pos =vec2(col,row)*vec2(8.0,10.0)+vec2(0.0,3.0);pos =((corners[gl_VertexID]*size +pos)+camOffset)*camScale;gl_Position =vec4(char ==0.0 ? vec2(2.0): pos,0.0,1.0);colourV =colour;fontCoord =(vec2(char -1.0,0.0)+corners[gl_VertexID])*vec2(5.0,7.0);}",wave_vert:"#version 300 es\nlayout(location =0)in uint value;const vec2 camScale =vec2(2.0 /320.0,-2.0 /240.0);const vec2 camOffset =vec2(-160.0,-120.0);void main(){vec2 pos =vec2(float(gl_VertexID),float(value));pos =(pos +vec2(0.5)+camOffset)*camScale;gl_PointSize =1.0;gl_Position =vec4(pos,0.0,1.0);}",blit_frag:"#version 300 es\nprecision highp float;uniform sampler2D src;in vec2 srcCoord;out vec4 fragColour;void main(){fragColour =texelFetch(src,ivec2(srcCoord),0);}",rect_frag:"#version 300 es\nprecision highp float;in vec3 colourV;out vec4 fragColour;void main(){fragColour =vec4(colourV,1.0);}",text_frag:"#version 300 es\nprecision highp float;uniform sampler2D font;in vec2 fontCoord;in vec3 colourV;out vec4 fragColour;void main(){vec4 fontTexel =texelFetch(font,ivec2(fontCoord),0);fragColour =vec4(colourV,fontTexel.r);}",wave_frag:"#version 300 es\nprecision highp float;uniform vec3 colour;out vec4 fragColour;void main(){fragColour =vec4(colour,1.0);}"});function u(e,t,r){const a=e.createShader(r);if(e.shaderSource(a,d[t]),e.compileShader(a),!e.getShaderParameter(a,e.COMPILE_STATUS))throw new Error(`Failed to compile shader (${t}): ${e.getShaderInfoLog(a)}`);return a}function h(e,t){return function(e,t,r,a){const n=e.createProgram();if(e.attachShader(n,r),e.attachShader(n,a),e.linkProgram(n),!e.getProgramParameter(n,e.LINK_STATUS))throw new Error(`Failed to link program (${t}): ${e.getProgramInfoLog(n)}`);return n}(e,t,u(e,`${t}_vert`,e.VERTEX_SHADER),u(e,`${t}_frag`,e.FRAGMENT_SHADER))}function f(e,t){return e+Math.floor(Math.random()*(t-e))}let _=!1;function v(){_||(window.location.reload(),_=!0)}let p=()=>{};n("#reload button","click",(()=>p())),n("#menu-button","click",(()=>{return e="#settings",void document.querySelectorAll(e).forEach((e=>e.classList.contains("hidden")?e.classList.remove("hidden"):e.classList.add("hidden")));var e})),n("#settings","click",(e=>{"settings"===e.target.id&&t("#settings")}));const g={},m={};function w(e,t,r){const a=E(e,r),o=document.createElement("div");o.classList.add("setting");const i=document.createElement("label");i.innerText=t,o.append(i);const s=document.createElement("input");s.setAttribute("type","checkbox"),s.checked=a,i.append(s),n(s,"change",(()=>A(e,s.checked))),document.getElementById("settings").append(o)}function b(e,r){const n=document.createElement("div");n.classList.add("setting"),a(n,r,(()=>{t("#settings"),g[e]&&g[e]()})),document.getElementById("settings").append(n)}function E(e,t){let r=localStorage[e];return r=void 0===r?t:JSON.parse(r),m[e]=r,r}function A(e,t){m[e]=t,g[e]&&g[e](t),localStorage[e]=JSON.stringify(t)}function x(e,t){g[e]=t,void 0!==y(e)&&t(y(e))}function y(e){return m[e]}let R;w("showControls","Show Controls",!1),w("hideMenu","Hide Menu",!1),w("enableAudio","Enable Audio",!0),function(e,t,r,a){const o=E(e,a),i=document.createElement("div");i.classList.add("setting");const s=document.createElement("label");s.innerText=t,i.append(s);const c=document.createElement("select");for(const[e,t]of Object.entries(r)){const r=document.createElement("option");r.value=e,r.text=t,c.append(r)}c.value=o,s.append(c),n(c,"change",(()=>A(e,c.value))),document.getElementById("settings").append(i)}("displayType","Display Type",{webgl2:"WebGL2",old:"Canvas + SVG"},"webgl2"),w("snapPixels","Snap Pixels",!0),b("controlMapping","Control Mapping"),b("firmware","Load Firmware"),b("fullscreen","Fullscreen"),b("about","About"),x("hideMenu",(e=>document.getElementById("settings").classList.toggle("auto-hide",e)));let T=0;const C={up:6,down:5,left:7,right:2,select:4,start:3,option:1,edit:0},S=Object.freeze({ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right",ShiftLeft:"select",Space:"start",KeyZ:"option",KeyX:"edit",Gamepad12:"up",Gamepad64:"up",Gamepad13:"down",Gamepad65:"down",Gamepad14:"left",Gamepad66:"left",Gamepad15:"right",Gamepad67:"right",Gamepad8:"select",Gamepad2:"select",Gamepad5:"select",Gamepad9:"start",Gamepad3:"start",Gamepad1:"option",Gamepad0:"edit"}),U={};function F(e,t,r){if(e)return V?(r&&r.preventDefault(),void(t&&V(e))):void B(U[e],t,r)}function D(e,t){const r=t.target.dataset.action;r&&(O&&e&&!V?async function(e,t){const r=e=>{e.stopPropagation(),q()};document.body.addEventListener("mousedown",r,!0),document.body.addEventListener("touchstart",r,!0),document.body.classList.add("capturing"),e.classList.add("mapping");try{const a=await(q(),new Promise((e=>{V=e})).then((e=>(V=null,e))));a&&(U[a]=t,A("inputMap",U))}finally{e.classList.remove("mapping"),document.body.classList.remove("capturing"),document.body.removeEventListener("touchstart",r,!0),document.body.removeEventListener("mousedown",r,!0)}}(t.target,r):(t.target.classList.toggle("active",e),B(r,e,t)))}function B(e,t,r){if(!e)return;r&&r.preventDefault();const a=C[e];if(void 0===a)return;const n=t?T|1<<a:T&~(1<<a);n!==T&&(T=n,R.sendKeys(T))}function I(e){R=e,document.addEventListener("keydown",(e=>F(e.code,!0,e))),document.addEventListener("keyup",(e=>F(e.code,!1,e)));const t=document.getElementById("controls");t.addEventListener("mousedown",(e=>D(!0,e))),t.addEventListener("touchstart",(e=>D(!0,e))),t.addEventListener("mouseup",(e=>D(!1,e))),t.addEventListener("touchend",(e=>D(!1,e))),a("#mapping-buttons","Reset to Default",X),a("#mapping-buttons","Clear All",Y),a("#mapping-buttons","Done",$),Object.assign(U,E("inputMap",S))}let k=!1;const L=[],N={0:[!0,!1,!1,!1],1:[!0,!1,!1,!0],2:[!1,!1,!1,!0],3:[!1,!0,!1,!0],4:[!1,!0,!1,!1],5:[!1,!0,!0,!1],6:[!1,!1,!0,!1],7:[!0,!1,!0,!1],8:[!1,!1,!1,!1],15:[!1,!1,!1,!1]};function P(){if(!k)return;let e=!1;for(const t of navigator.getGamepads()){if(!t||!t.connected)continue;e=!0;let r=L[t.index];if(r||(r=L[t.index]={buttons:[],axes:[]}),"standard"!==t.mapping)for(let e=0;e<t.axes.length;e++){if(!1===r.axes[e])continue;const a=3.5*(t.axes[e]+1),n=Math.abs(Math.round(a)-a),o=N[Math.round(a)];if(n>48e-8||void 0===o)r.axes[e]=!1;else if(0!==a||!0===r.axes[e]){r.axes[e]=!0;for(let e=0;e<4;e++){const t=o[e];r.buttons[64+e]!==t&&(r.buttons[64+e]=t,F(`Gamepad${64+e}`,t))}}}for(let e=0;e<t.buttons.length;e++){const a=t.buttons[e].pressed;r.buttons[e]!==a&&(r.buttons[e]=a,F(`Gamepad${e}`,a))}}e?requestAnimationFrame(P):k=!1}window.addEventListener("gamepadconnected",(e=>{"standard"!==e.gamepad.mapping&&console.warn("Non-standard gamepad attached. Mappings may be funny."),k||(k=!0,P())})),window.addEventListener("gamepaddisconnected",(e=>{L[e.gamepad.index]=null}));let M,O=!1,G=null,V=null;function $(){q(),document.body.classList.remove("mapping"),O=!1,G&&G()}function q(){V&&V(null)}function X(){for(const e of Object.keys(U))delete U[e];Object.assign(U,S),A("inputMap",U)}function Y(){for(const e of Object.keys(U))delete U[e];A("inputMap",U)}let W=!0;async function H(e=1){if(!M&&W){try{let t;for(M=new AudioContext,await navigator.mediaDevices.getUserMedia({audio:!0});t=await Q(),!t&&--e>0;)await r(300);if(!t)throw new Error("M8 not found");const a=await navigator.mediaDevices.getUserMedia({audio:{deviceId:{exact:t},autoGainControl:!1,echoCancellation:!1,noiseSuppression:!1}});M.createMediaStreamSource(a).connect(M.destination),"running"!==M.state&&function(){const e=["keydown","mousedown","touchstart"];function t(){M&&M.resume(),e.forEach((e=>document.removeEventListener(e,t)))}e.forEach((e=>document.addEventListener(e,t)))}()}catch(e){console.error(e),z()}W||z()}}async function Q(){return(await navigator.mediaDevices.enumerateDevices()).filter((e=>"audioinput"===e.kind&&/M8/.test(e.label)&&"default"!==e.deviceId&&"communications"!==e.deviceId)).map((e=>e.deviceId))[0]}async function z(){M&&await M.close().catch((()=>{})),M=null}const j=Symbol("START_LINE"),Z=Symbol("HEX1"),J=Symbol("HEX2");async function K(e,t,r){const a=[];for await(let{address:n,data:o}of async function*(e){const t=new Uint8Array(260);let r=j,a=1,n=0,o=0,i=0,s=0,c=1,l=!1,d=0;const u=e.stream().getReader();for(;;){const e=await u.read();if(!e.value)break;for(const u of e.value){if(n++,l)throw new te(`Unexpected data after end record, line ${a} char ${n}`);switch(r){case j:switch(u){case 58:r=Z;break;default:throw new te(`Expecting ':' at start of line ${a} char ${n}`)}break;case Z:if(13===u)continue;if(10===u){if(o<c)throw new te(`Unexpected end of line on line ${a} char ${n}`);if(0!==s)throw new te(`Invalid checksum on line ${a}`);switch(t[3]){case 0:yield{address:d+256*t[1]+t[2],data:t.subarray(4,c-1)};break;case 1:l=!0;break;case 2:d=256*t[4]+t[5]<<4;break;case 3:break;case 4:d=256*t[4]+t[5]<<16;break;case 5:break;default:throw new te(`Invalid record type on line ${a}`)}r=j,a++,n=0,o=0,s=0,c=1}else{if(o>=c)throw new te(`Record too long on line ${a} char ${n}`);const e=ee(u);if(null===e)throw new te(`Expecting hex character on line ${a} char ${n}`);i=16*e,r=J}break;case J:const e=ee(u);if(null===e)throw new te(`Expecting hex character on line ${a} char ${n}`);i+=e,s=s+i&255,0===o&&(c=i+5),t[o++]=i,r=Z}}if(e.done)break}if(l)return;if(r!=Z||byte<c)throw new te(`Unexpected end of file, line ${a} char ${n}`);if(0!==s)throw new te(`Invalid checksum on line ${a}`);if(1!==t[3])throw new te(`Missing end of file record, line ${a}`)}(e)){if(n-=r,n<0)throw new te("Negative address after applying offset");let e=Math.floor(n/t),i=0;for(;i<o.length;){let r=a[e];r||(r=a[e]=new Uint8Array(t),r.fill(255));const s=e*t,c=s+t,l=n+i-s,d=n+o.length>c?t:l+o.length-i;for(let e=l;e<d;e++)r[e]=o[i++];e++}}return a}function ee(e){return e>=48&&e<=57?e-48:e>=65&&e<=70?e-55:e>=97&&e<=102?e-87:null}class te extends Error{constructor(...e){super(...e),this.name="HexFormatError"}}function re(e){document.getElementById("firmware").className=e}let ae=null,ne=null;function oe(e,t,r){const a=`rgb(${e}, ${t}, ${r})`;document.body.style.backgroundColor=a,document.documentElement.style.backgroundColor=a,A("background",[e,t,r])}n("#firmware button.close","click",(()=>{ae=null,ne=null,document.querySelector("#firmware input").value=null,re("hidden")})),n("#firmware input","change",(async e=>{ae=null;const t=e.target.files[0];if(t){re("file-loading");try{ae=await K(t,1024,1610612736)}catch(e){return console.error(e),void re("file-error")}re("file-loaded")}})),n("#firmware button.select-device","click",(async()=>{ne=null;const e=await navigator.hid.requestDevice({filters:[{vendorId:5824,productId:1144}]});ne=e&&e[0],ne&&(!function(e){const t=e.collections[0];return t&&65436===t.usagePage&&37===t.usage}(ne)?(ne=null,re("device-error")):re("device-selected"))})),n("#firmware button.flash","click",(async()=>{const e=document.querySelector("#firmware progress.flash");re("flashing");try{await async function(e,t,a){a(0),await t.open();try{const n=new Uint8Array(1088);for(let o=0;o<e.length;o++){if(0!==o&&(!e[o]||e[o].every((e=>255===e))))continue;const i=1024*o;n[0]=255&i,n[1]=i>>8&255,n[2]=i>>16&255,n.set(e[o],64),await t.sendReport(0,n),a((o+1)/e.length),await r(0===o?1500:5)}n.fill(0),n[0]=255,n[1]=255,n[2]=255,await t.sendReport(0,n)}finally{await t.close().catch((()=>{}))}}(ae,ne,(t=>e.value=t))}catch(e){return console.error(e),void re("flash-error")}re("flash-success")}));const ie=E("background",[0,0,0]);oe(ie[0],ie[1],ie[2]);const se="webgl2"===y("displayType")?new class{_canvas;_gl;_bg=[0,0,0];_frameQueued=!1;_onBackgroundChanged;constructor(e,t){this._bg=[e[0]/255,e[1]/255,e[2]/255],this._onBackgroundChanged=t,this._canvas=document.getElementById("canvas"),this._gl=this._canvas.getContext("webgl2",{alpha:!1,antialias:!1});const r=this._gl;this._setupRects(r),this._setupText(r),this._setupWave(r),r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),r.viewport(0,0,320,240),this._queueFrame()}_rectShader;_rectVao;_rectShapes=new Uint16Array(6144);_rectColours=new Uint8Array(this._rectShapes.buffer,8);_rectCount=0;_rectsClear=!0;_rectsTex;_rectsFramebuffer;_blitShader;_setupRects(e){this._rectShader=h(e,"rect"),this._rectVao=e.createVertexArray(),e.bindVertexArray(this._rectVao),this._rectShapes.glBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._rectShapes.glBuffer),e.bufferData(e.ARRAY_BUFFER,this._rectShapes,e.STREAM_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,4,e.UNSIGNED_SHORT,!1,12,0),e.vertexAttribDivisor(0,1),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,3,e.UNSIGNED_BYTE,!0,12,8),e.vertexAttribDivisor(1,1),this._rectsTex=e.createTexture(),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this._rectsTex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,320,240,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),this._rectsFramebuffer=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._rectsFramebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this._rectsTex,0),this._blitShader=h(e,"blit"),e.useProgram(this._blitShader),e.uniform1i(e.getUniformLocation(this._blitShader,"src"),0)}_renderRects(e){this._rectsClear&&(e.bindFramebuffer(e.FRAMEBUFFER,this._rectsFramebuffer),e.clearColor(this._bg[0],this._bg[1],this._bg[2],1),e.clear(e.COLOR_BUFFER_BIT),this._rectsClear=!1),this._rectCount>0&&(e.bindFramebuffer(e.FRAMEBUFFER,this._rectsFramebuffer),e.useProgram(this._rectShader),e.bindVertexArray(this._rectVao),e.bindBuffer(e.ARRAY_BUFFER,this._rectShapes.glBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._rectShapes.subarray(0,6*this._rectCount)),e.drawArraysInstanced(e.TRIANGLE_STRIP,0,4,this._rectCount),this._rectCount=0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.useProgram(this._blitShader),e.drawArrays(e.TRIANGLE_STRIP,0,4)}drawRect(e,t,r,a,n,o,i){if(0===e&&0===t&&320===r&&240===a)this._onBackgroundChanged(n,o,i),this._bg=[n/255,o/255,i/255],this._rectCount=0,this._rectsClear=!0;else if(this._rectCount<1024){const s=this._rectCount;this._rectShapes[6*s+0]=e,this._rectShapes[6*s+1]=t,this._rectShapes[6*s+2]=r,this._rectShapes[6*s+3]=a,this._rectColours[12*s+0]=n,this._rectColours[12*s+1]=o,this._rectColours[12*s+2]=i,this._rectCount++}else console.warn("Out of rects!");this._queueFrame()}_textShader;_textVao;_textTex;_textColours=new Uint8Array(2880);_textChars=new Uint8Array(960);_setupText(e){this._textShader=h(e,"text"),e.useProgram(this._textShader),e.uniform1i(e.getUniformLocation(this._textShader,"font"),1),this._textVao=e.createVertexArray(),e.bindVertexArray(this._textVao),this._textColours.glBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._textColours.glBuffer),e.bufferData(e.ARRAY_BUFFER,this._textColours,e.DYNAMIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,3,e.UNSIGNED_BYTE,!0,0,0),e.vertexAttribDivisor(0,1),this._textChars.glBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._textChars.glBuffer),e.bufferData(e.ARRAY_BUFFER,this._textChars,e.DYNAMIC_DRAW),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,1,e.UNSIGNED_BYTE,!1,0,0),e.vertexAttribDivisor(1,1),this._textTex=e.createTexture(),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this._textTex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,470,7,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST);const t=new Image;t.onload=()=>{e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this._textTex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,470,7,0,e.RGBA,e.UNSIGNED_BYTE,t),this._queueFrame()},t.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdYAAAAHAQMAAACPwf4nAAAABlBMVEUAAAD///+l2Z/dAAABfklEQVQY0z2QsUsCcRTHn3rQL1G4MwSD4F52UDT1g6AlTr0GbQiKENoqxEFocRIryMThgiMJkhZNtCZr6U8I9HAoUYjGbKrRavEs67o7qO/wpvf5ft/3gT8TnMsiAARedV7XNQBbK1XqfXe0GGk8pcqaSvP3DpYBUwj/YiQAf2HYzHkyABSXfEEqA/qpEvNJFOPuF6psRVQqL9tmGAbYiT/O2AYSEgADK6sMRwDWLfaIhNkFZdsncZhwPlrsrCwfAhyc96feMOYedPe6mnqTb4Y2AL0fAuMpjkBhWteHmxpkSFSv8Ls8JklLzBcjqpAmIQDDrypi3KlSBWW1JueMm1GMPjAsAdu4YGfrJwTC7JmZmxQSRJ27zkZqNSeZNFlef8e0yYqyemn5gXfQZFgI2jmLHSWIrNVXiBvsqRS5SroIZ+UiNXPFoV02/ULm64LzdmN4eP2HH5aJ0fw4X+rddr4utEZ7Zz/sof27Mcez0bfSSVU/G23XYopb69cl+AW0nopO+Ne2hgAAAABJRU5ErkJggg=="}_renderText(e){e.useProgram(this._textShader),e.bindVertexArray(this._textVao),this._textColours.updated&&(e.bindBuffer(e.ARRAY_BUFFER,this._textColours.glBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._textColours),this._textColours.updated=!1),this._textChars.updated&&(e.bindBuffer(e.ARRAY_BUFFER,this._textChars.glBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._textChars),this._textChars.updated=!1),e.drawArraysInstanced(e.TRIANGLE_STRIP,0,4,960)}drawText(e,t,r,a,n,o){const i=40*Math.floor(r/10)+Math.floor(t/8);this._textChars[i]=e-32,this._textChars.updated=!0,this._textColours[3*i+0]=a,this._textColours[3*i+1]=n,this._textColours[3*i+2]=o,this._textColours.updated=!0,this._queueFrame()}_waveData=new Uint8Array(320);_waveColour=new Float32Array([.5,1,1]);_waveOn=!1;_setupWave(e){this._waveShader=h(e,"wave"),this._waveShader.colourUniform=e.getUniformLocation(this._waveShader,"colour"),this._waveVao=e.createVertexArray(),e.bindVertexArray(this._waveVao),this._waveData.glBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._waveData.glBuffer),e.bufferData(e.ARRAY_BUFFER,this._waveData,e.STREAM_DRAW),e.enableVertexAttribArray(0),e.vertexAttribIPointer(0,1,e.UNSIGNED_BYTE,1,0)}_renderWave(e){this._waveOn&&(e.useProgram(this._waveShader),e.uniform3fv(this._waveShader.colourUniform,this._waveColour),e.bindVertexArray(this._waveVao),this._waveData.updated&&(e.bindBuffer(e.ARRAY_BUFFER,this._waveData.glBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._waveData),this._waveData.updated=!1),e.drawArrays(e.POINTS,0,320))}drawWave(e,t,r,a){this._waveColour[0]=e/255,this._waveColour[1]=t/255,this._waveColour[2]=r/255,320==a.length?(this._waveData.set(a),this._waveData.updated=!0,this._waveOn=!0,this._queueFrame()):this._waveOn&&(this._waveOn=!1,this._queueFrame())}_randomData(){for(let e=0;e<10;e++)this.drawRect(f(0,300),f(0,220),f(5,25),f(5,25),f(0,255),f(0,255),f(0,255));for(let e=0;e<320;e+=8)for(let t=0;t<240;t+=10)this.drawText(String.fromCharCode(f(20,126)),e,t,f(0,255),f(0,255),f(0,255));this.drawWave(f(0,255),f(0,255),f(0,255),new Uint8Array(Array(320).fill().map((()=>f(0,20)))))}_renderFrame(){const e=this._gl;this._renderRects(e),this._renderText(e),this._renderWave(e),this._frameQueued=!1}_queueFrame(){this._frameQueued||(requestAnimationFrame((()=>this._renderFrame())),this._frameQueued=!0)}clear(){this._rectsClear=!0,this._rectCount=0,this._textChars.fill(0),this._textChars.updated=!0,this._waveOn=!1,this._queueFrame()}}(ie,oe):new class{_canvas;_ctx;_textNodes=[];_backgroundColour="rgb(0, 0, 0)";_frameQueued=!1;_rects=[];_waveColour="rgb(255, 255, 255)";_waveData=new Uint8Array(320);_waveOn=!1;_textUpdates={};_onBackgroundChanged;constructor(e,t){this._backgroundColour=`rgb(${e[0]}, ${e[1]}, ${e[2]})`,this._onBackgroundChanged=t,this._canvas=document.getElementById("canvas"),this._ctx=canvas.getContext("2d"),this._buildText()}_buildText(){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");for(t.setAttributeNS(null,"viewBox","0 0 640 480");t.firstChild;)t.removeChild(t.lastChild);for(let r=0;r<25;r++)for(let a=0;a<39;a++){const n=document.createElementNS(e,"text");n.setAttributeNS(null,"x",16*a),n.setAttributeNS(null,"y",20*r+20),n.setAttributeNS(null,"fill","_000");const o=document.createTextNode("");n.appendChild(o),t.appendChild(n),this._textNodes[39*r+a]={node:o,char:32,fill:"_000"}}this._canvas.insertAdjacentElement("afterend",t)}_renderFrame(){for(let e=0;e<this._rects.length;e++){const t=this._rects[e];this._ctx.fillStyle=t.colour,this._ctx.fillRect(t.x,t.y,t.w,t.h)}if(this._rects.length=0,this._waveUpdated&&(this._ctx.fillStyle=this._backgroundColour,this._ctx.fillRect(0,0,320,21),this._waveOn)){this._ctx.fillStyle=this._waveColour;for(let e=0;e<this._waveData.length;e++){const t=Math.min(this._waveData[e],20);this._ctx.fillRect(e,t,1,1)}}this._waveUpdated=!1;for(const[e,t]of Object.entries(this._textUpdates)){const e=t.node;t.char!==e.char&&(e.node.nodeValue=String.fromCharCode(t.char),e.char=t.char),t.fill!==e.fill&&(e.node.parentElement.setAttributeNS(null,"fill",t.fill),e.fill=t.fill)}this._textUpdates={},this._frameQueued=!1}_queueFrame(){this._frameQueued||(requestAnimationFrame((()=>this._renderFrame())),this._frameQueued=!0)}drawRect(e,t,r,a,n,o,i){const s=`rgb(${n}, ${o}, ${i})`;0===e&&0===t&&320===r&&240===a&&(this._rects.length=0,this._backgroundColour=s,this._onBackgroundChanged(n,o,i)),this._rects.push({colour:s,x:e,y:t,w:r,h:a}),this._queueFrame()}drawText(e,t,r,a,n,o){const i=39*Math.floor(r/10)+Math.floor(t/8);this._textNodes[i]&&(this._textUpdates[i]={node:this._textNodes[i],char:e,fill:`rgb(${a}, ${n}, ${o})`},this._queueFrame())}drawWave(e,t,r,a){this._waveColour=`rgb(${e}, ${t}, ${r})`,320==a.length?(this._waveData.set(a),this._waveOn=!0,this._waveUpdated=!0,this._queueFrame()):this._waveOn&&(this._waveOn=!1,this._waveUpdated=!0,this._queueFrame())}clear(){this._rects=[{colour:this._backgroundColour,x:0,y:0,w:320,h:240}],this._waveOn=!1,this._waveUpdated=!0,this._textUpdates={};for(let e=0;e<this._textNodes.length;e++)this._textUpdates[e]={node:this._textNodes[e],char:32,fill:"rgb(0, 0, 0)"};this._queueFrame()}}(ie,oe),ce=new class{_state=s;_buffer=new Uint8Array(512);_i=0;_renderer;constructor(e){this._renderer=e}_processFrame(e){switch(e[0]){case 254:e.length>=12?this._renderer.drawRect(e[1]+256*e[2],e[3]+256*e[4],e[5]+256*e[6],e[7]+256*e[8],e[9],e[10],e[11]):console.log("Bad RECT frame");break;case 253:e.length>=9?this._renderer.drawText(e[1],e[2]+256*e[3],e[4]+256*e[5],e[6],e[7],e[8]):console.log("Bad TEXT frame");break;case 252:e.length>=4?this._renderer.drawWave(e[1],e[2],e[3],e.subarray(4)):console.log("Bad WAVE frame");break;case 251:break;default:console.log("BAD FRAME")}}process(e){for(let t=0;t<e.length;t++){const r=e[t];switch(this._state){case s:switch(r){case 192:this._processFrame(this._buffer.subarray(0,this._i)),this._i=0;break;case 219:this._state=c;break;default:this._buffer[this._i++]=r}break;case c:switch(r){case 220:this._buffer[this._i++]=192,this._state=s;break;case 221:this._buffer[this._i++]=219,this._state=s;break;default:this._state=l,console.log("Unexpected SLIP sequence")}break;case l:switch(r){case 192:this._state=s,this._i=0,console.log("SLIP recovered")}}}}reset(){this._state=s,this._i=0}}(se);let le=function(){const e=document.getElementById("display"),t=document.getElementById("canvas"),r=document.querySelector("#canvas + svg");function a(){const a=devicePixelRatio,n=e.clientWidth*a;if(y("snapPixels")&&n<=1600){let o=e.clientHeight*a;(y("showControls")||O)&&(o/=2);const i=320*Math.floor(n/320)/a,s=240*Math.floor(o/240)/a,c=Math.round((n/a-i)/2),l=Math.round((o/a-s)/2);t.style.width=`${i}px`,t.style.height=`${s}px`,t.style.left=`${c}px`,t.style.top=`${l}px`,r&&(r.style.width=`${i}px`,r.style.height=`${s}px`,r.style.left=`${c}px`,r.style.top=`${l}px`)}else t.style.width=null,t.style.height=null,t.style.left=null,t.style.top=null,r&&(r.style.width=null,r.style.height=null,r.style.left=null,r.style.top=null)}return n(window,"resize",a),window.matchMedia("screen and (min-resolution: 2dppx)").addListener(a),a(),a}();function de(r){r?(t("#buttons, .error, #info"),H(10)):(se.clear(),e("#buttons"),z())}if(x("showControls",(e=>{document.getElementById("display").classList.toggle("with-controls",e),le()})),x("enableAudio",(e=>{e?W||(W=!0,H()):(W=!1,z())})),x("snapPixels",(()=>le())),x("controlMapping",(()=>{t("#info"),(O=!0,document.body.classList.add("mapping"),new Promise((e=>{G=e}))).then(le),le()})),x("firmware",(()=>{t("#info"),ae=null,ne=null,re("file-select")})),x("fullscreen",(()=>{document.fullscreenElement?document.exitFullscreen():document.body.requestFullscreen()})),x("about",(()=>e("#info"))),navigator.serial){const r=new i(ce,de);I(r),a("#buttons","Connect",(()=>r.connect().catch((()=>{t("#info"),e("#serial-fail")})))),n(window,"beforeunload",(e=>r.disconnect())),r.connect(!0).catch((()=>{}))}else if(navigator.usb){const r=new o(ce,de);I(r),a("#buttons","Connect with WebUSB",(()=>r.connect().catch((()=>{t("#info"),e("#usb-fail")})))),e("#buttons")}else e("#no-serial-usb");n("#info button","click",(()=>t("#info"))),async function(){navigator.serviceWorker.addEventListener("controllerchange",(()=>v()));let t=!navigator.serviceWorker.controller;const r=await navigator.serviceWorker.register("worker.js");r.addEventListener("updatefound",(()=>{if(t)return void(t=!1);const a=r.installing;a.addEventListener("statechange",(()=>{"installed"===a.state&&(p=navigator.serviceWorker.controller?()=>a.postMessage({action:"skipWaiting"}):v,e("#reload"))}))})),setInterval((()=>r.update()),18e5)}();

</script></body></html>
