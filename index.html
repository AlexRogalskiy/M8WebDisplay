<!DOCTYPE html>
<!--
    Copyright 2021 James Deery
    Released under the MIT licence, https://opensource.org/licenses/MIT
 -->
<html>
<head>
    <title>M8 Display</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/png" href="icon.png">
    <link rel="manifest" href="app.webmanifest">
    <style>
@font-face{font-family:"stealth57";src:url("data:font/woff2;base64,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") format("woff2")}body{font-family:sans-serif;background-color:#000;color:#eee;margin:0px;font-size:16px}a,a:visited{color:#00efff}a:focus,a:visited:focus{outline:1px solid #00efff}.hidden{display:none}label,input,select,button{appearance:none;font-family:"stealth57";font-size:14px;background-color:#000;color:#fff}label:hover,input:hover,select:hover,button:hover{background-color:#00efff;color:#000}label:active,input:active,select:active,button:active{background-color:#00bfcc;color:#fff}label:focus,label:focus-within,input:focus,input:focus-within,select:focus,select:focus-within,button:focus,button:focus-within{outline:none;color:#00efff}label:focus:hover,label:focus-within:hover,input:focus:hover,input:focus-within:hover,select:focus:hover,select:focus-within:hover,button:focus:hover,button:focus-within:hover{color:#000}label:focus:active,label:focus-within:active,input:focus:active,input:focus-within:active,select:focus:active,select:focus-within:active,button:focus:active,button:focus-within:active{color:#fff}button{border:3px solid #fff;padding:20px}input[type=checkbox]{font-family:"stealth57"}input[type=checkbox]::after{content:"OFF"}input[type=checkbox]:checked::after{content:"ON"}select{padding:5px 32px 5px 5px;background-color:transparent;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23fff' stroke-width='3' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right 10px center;background-size:16px;font-family:sans-serif;font-size:12px}#info{position:fixed;width:100%;bottom:0;text-align:center;padding:5px;background-color:rgba(0,0,0,.5)}#display{position:relative;width:100vw;height:75vw;max-width:133.3333333333vh;max-height:100vh;margin:0 auto;top:0;bottom:0;left:0;right:0;user-select:none}#display canvas,#display svg{position:absolute;width:100%;height:100%}#display canvas{image-rendering:pixelated}#display svg text{font-family:"stealth57";font-size:16px}#display #buttons{position:absolute;top:25px;width:100%;text-align:center}#display .error{position:absolute;top:100px;left:100px;right:100px;border:3px solid #fff;border-radius:10px;padding:20px;background-color:#a22;user-select:text}#display .error p{margin-top:0}#display .error p:last-child{margin-bottom:0}#display.with-controls{height:150vw;max-width:66.6666666667vh}#display.with-controls canvas,#display.with-controls svg{height:50%}#display.with-controls #controls{display:block}#display #controls{display:none;position:relative;width:100%;height:50%;top:50%}#display #controls rect{fill:#333;rx:10px;stroke:#aaa;stroke-width:3px;width:130px;height:130px}#display #controls rect.active{stroke:#00efff}#reload{position:fixed;bottom:0;left:0;right:0;text-align:center}#reload button{border-bottom-width:0}#settings{position:fixed;top:0;bottom:0;left:0;right:0;background-color:rgba(0,0,0,.5);transition:background-color 80ms linear 0s;user-select:none}#settings.hidden{display:block;width:0;height:0;background-color:rgba(0,0,0,0)}#settings.hidden .setting{visibility:hidden;margin-left:-323px;transition:none}#settings.hidden .control{background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23fff' stroke-width='1.5' d='M2 4h12M2 8h12M2 12h12'/%3e%3c/svg%3e")}#settings .control{width:32px;height:32px;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23fff' stroke-width='1.5' d='M3 3l10 10M3 13l10-10'/%3e%3c/svg%3e");background-repeat:no-repeat;background-color:transparent;border-color:transparent;font-size:0;margin-bottom:-3px}#settings .control:hover{background-color:#00efff}#settings .control:active{background-color:#00bfcc;color:#fff}#settings .control:focus{color:#00efff;border-color:#00efff}#settings .control:focus:hover{color:#000}#settings .control:focus:active{color:#fff}#settings .setting{width:320px;border:3px solid #fff;border-width:3px 3px 0 0;margin-left:0;transition:margin-left 80ms linear 0s}#settings .setting:last-child{border-bottom-width:3px}#settings .setting label{display:block;position:relative;padding:10px}#settings .setting label input,#settings .setting label select{position:absolute;top:0;bottom:0;right:0;margin:0;border:0}#settings .setting label input[type=checkbox]{padding:10px}#settings .setting label select{width:50%}#settings .setting button{display:block;width:100%;margin:0;border:0;padding:10px}

</style>
    <style>
    </style>
</head>
<body>
    <div id="display">
        <canvas id="canvas" width="320" height="240"></canvas>

        <div id="serial-fail" class="error hidden">
            <p>Failed to connect over Serial.
            Are you sure your Teensy is connected and the M8 Headless firmware is loaded?</p>
            <p>Make sure that there are no other programs running which may have the serial port open.</p>
            <p>It is also possible there's a bug in this code.
            There may be some messages in the developer console that will help with debugging.
        </p></div>
        <div id="usb-fail" class="error hidden">
            <p>Failed to connect with WebUSB.
            Are you sure your Teensy is connected and the M8 Headless firmware is loaded?</p>
            <p>Connecting with WebUSB is known not to work on Windows or Linux.
            If you are using Chrome you can use Serial instead but you need to enable an experimental flag by going to <code>chrome://flags</code> and enabling "Experimental Web Platform features".</p>
        </div>
        <div id="no-serial-usb" class="error hidden">
            <p>Your browser doesn't appear to have Serial or WebUSB support.
            These are only currently supported in Chrome and some Chrome-derived browsers.</p>
        </div>

        <div id="buttons" class="hidden"></div>

        <svg id="controls" viewBox="0 0 640 480">
            <rect data-key="edit" x="490" y="10"/>
            <rect data-key="option" x="340" y="10"/>
            <rect data-key="up" x="160" y="30"/>
            <rect data-key="left" x="10" y="180"/>
            <rect data-key="down" x="160" y="180"/>
            <rect data-key="right" x="310" y="180"/>
            <rect data-key="select" x="175" y="340"/>
            <rect data-key="start" x="325" y="340"/>
        </svg>
    </div>

    <div id="settings" class="hidden">
        <button class="control">Menu</button>
        <div class="setting">
            <label>
                Show Controls
                <input type="checkbox" id="show-controls-setting">
            </label>
        </div>
        <!--
        <div class="setting">
            <label>
                Expand View
                <input type="checkbox" id="expand-view-setting">
            </label>
        </div>
        -->
        <div class="setting">
            <label>
                Enable Audio
                <input type="checkbox" id="enable-audio-setting">
            </label>
        </div>
        <!--
        <div class="setting">
            <label>
                Audio Input
                <select id="audio-input-setting" disabled>
                    <option>None available</option>
                </select>
            </label>
        </div>
        <div class="setting">
            <label>
                Audio Output
                <select id="audio-output-setting" disabled>
                    <option>None available</option>
                </select>
            </label>
        </div>
        -->
        <div class="setting">
            <label>
                Display Type
                <select id="display-type-setting">
                    <option value="webgl2">WebGL2</option>
                    <option value="old">Canvas + SVG</option>
                </select>
            </label>
        </div>
        <!--
        <div class="setting">
            <button id="open-keyboard-mapping">Keyboard Mapping</button>
        </div>
        <div class="setting">
            <button id="open-gamepad-mapping">Gamepad Mapping</button>
        </div>
        -->
        <div class="setting">
            <button id="go-fullscreen">Fullscreen</button>
        </div>
    </div>

    <div id="info">
        Work in progress, use at your own risk.
        More details at <a href="https://github.com/derkyjadex/M8WebDisplay">https://github.com/derkyjadex/M8WebDisplay</a>.
    </div>

    <div id="reload" class="hidden">
        <button>An update is available. Click to reload.</button>
    </div>

    <script>
function show(e){document.querySelectorAll(e).forEach((e=>e.classList.remove("hidden")))}function hide(e){document.querySelectorAll(e).forEach((e=>e.classList.add("hidden")))}function toggle(e){document.querySelectorAll(e).forEach((e=>e.classList.contains("hidden")?e.classList.remove("hidden"):e.classList.add("hidden")))}function wait(e){return new Promise((t=>setTimeout(t,e)))}class UsbConnection{_device;_parser;_onConnectionChanged;constructor(e,t){this._parser=e,this._onConnectionChanged=t}get isConnected(){return!!this._device}async _startReading(){try{for(;this._device;){const e=await this._device.transferIn(3,512);"ok"!==e.status?this.disconnect():this._parser.process(new Uint8Array(e.data.buffer))}}catch(e){console.error(e),this.disconnect()}}async sendKeys(e){if(this._device)try{await this._device.transferOut(3,new Uint8Array([67,e]))}catch(e){console.error(e),this.disconnect()}}async _reset(){await this._device.transferOut(3,new Uint8Array([68])),await wait(50),this._parser.reset(),await this._device.transferOut(3,new Uint8Array([69,82]))}async disconnect(){const e=this._device;e&&(this._device=null,await e.close().catch((()=>{})),this._onConnectionChanged(!1))}async connect(){if(!this._device)try{const e=await navigator.usb.getDevices();this._device=e.filter((e=>5824===e.vendorId&&1162===e.productId))[0],this._device||(this._device=await navigator.usb.requestDevice({filters:[{vendorId:5824,productId:1162}]})),await this._device.open(),await this._device.selectConfiguration(1),await this._device.claimInterface(1),await this._device.controlTransferOut({requestType:"class",recipient:"interface",request:34,value:3,index:1}),await this._device.controlTransferOut({requestType:"class",recipient:"interface",request:32,value:0,index:1},new Uint8Array([128,37,0,0,0,0,8])),await this._reset(),this._startReading(),this._onConnectionChanged(!0)}catch(e){if(this.disconnect(e),e.code!==DOMException.NOT_FOUND_ERR)throw console.error(e),e}}deviceInfo(){const e=this._device.configuration.interfaces.flatMap((e=>e.alternates[0].endpoints.map((t=>({ifNum:e.interfaceNumber,class:e.alternates[0].interfaceClass,subClass:e.alternates[0].interfaceSubclass,protocol:e.alternates[0].interfaceProtocol,epNum:t.endpointNumber,epDir:t.direction,epType:t.type,epPacketSize:t.packetSize})))));console.table(e)}}class SerialConnection{_port;_parser;_onConnectionChanged;_waitingForUserSelection;constructor(e,t){this._parser=e,this._onConnectionChanged=t,this._waitingForUserSelection=!1,navigator.serial.addEventListener("connect",(e=>{this._waitingForUserSelection||this.connect().catch((()=>{}))}))}get isConnected(){return!!this._port}async _startReading(){try{for(;this._port;){const{value:e,done:t}=await this._port.reader.read();if(e)try{this._parser.process(e)}catch(e){console.error(e)}if(t)return}}catch(e){console.error(e),this.disconnect()}}async sendKeys(e){if(this._port&&this._port.writer)try{await this._port.writer.write(new Uint8Array([67,e]))}catch(e){console.error(e),this.disconnect()}}async _reset(){await this._port.writer.write(new Uint8Array([68])),await wait(50),this._parser.reset(),await this._port.writer.write(new Uint8Array([69,82]))}async disconnect(){const e=this._port;e&&(this._port=null,await e.writer.write(new Uint8Array([68])).catch((()=>{})),e.reader&&await e.reader.cancel().catch((()=>{})),await e.close().catch((()=>{})),this._onConnectionChanged(!1))}async connect(e=!1){if(!this._port)try{const t=await navigator.serial.getPorts();if(this._port=t.filter((e=>{const t=e.getInfo();return 5824===t.usbVendorId&&1162===t.usbProductId}))[0],this._port||(e?this._onConnectionChanged(!1):this._port=await this._requestPort()),!this._port)return;await this._port.open({baudRate:9600,dataBits:8,stopBits:1,parity:"none",bufferSize:512}),this._port.reader=await this._port.readable.getReader(),this._port.writer=await this._port.writable.getWriter(),await this._reset(),this._startReading(),this._onConnectionChanged(!0)}catch(e){throw console.error(e),this.disconnect(e),e}}async _requestPort(){this._waitingForUserSelection=!0;try{return await navigator.serial.requestPort({filters:[{usbVendorId:5824,usbProductId:1162}]})}catch(e){if(e.code!==DOMException.NOT_FOUND_ERR)throw e;return null}finally{this._waitingForUserSelection=!1}}}const NORMAL=Symbol("normal"),ESCAPE=Symbol("escape"),ERROR=Symbol("error");class Parser{_state=NORMAL;_buffer=new Uint8Array(512);_i=0;_renderer;constructor(e){this._renderer=e}_processFrame(e){switch(e[0]){case 254:e.length>=12?this._renderer.drawRect(e[1]+256*e[2],e[3]+256*e[4],e[5]+256*e[6],e[7]+256*e[8],e[9],e[10],e[11]):console.log("Bad RECT frame");break;case 253:e.length>=9?this._renderer.drawText(String.fromCharCode(e[1]),e[2]+256*e[3],e[4]+256*e[5],e[6],e[7],e[8]):console.log("Bad TEXT frame");break;case 252:e.length>=4?this._renderer.drawWave(e[1],e[2],e[3],e.subarray(4)):console.log("Bad WAVE frame");break;case 251:break;default:console.log("BAD FRAME")}}process(e){for(let t=0;t<e.length;t++){const r=e[t];switch(this._state){case NORMAL:switch(r){case 192:this._processFrame(this._buffer.subarray(0,this._i)),this._i=0;break;case 219:this._state=ESCAPE;break;default:this._buffer[this._i++]=r}break;case ESCAPE:switch(r){case 220:this._buffer[this._i++]=192,this._state=NORMAL;break;case 221:this._buffer[this._i++]=219,this._state=NORMAL;break;default:this._state=ERROR,console.log("Unexpected SLIP sequence")}break;case ERROR:switch(r){case 192:this._state=NORMAL,this._i=0,console.log("SLIP recovered")}}}}reset(){this._state=NORMAL,this._i=0}}class Renderer{_canvas;_ctx;_textNodes=[];_backgroundColour="rgb(0, 0, 0)";_frameQueued=!1;_rects=[];_waveColour="rgb(255, 255, 255)";_waveData=new Uint8Array(320);_waveOn=!1;_textUpdates={};_onBackgroundChanged;constructor(e,t){this._backgroundColour=`rgb(${e[0]}, ${e[1]}, ${e[2]})`,this._onBackgroundChanged=t,this._canvas=document.getElementById("canvas"),this._ctx=canvas.getContext("2d"),this._buildText()}_buildText(){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");for(t.setAttributeNS(null,"viewBox","0 0 640 480");t.firstChild;)t.removeChild(t.lastChild);for(let r=0;r<25;r++)for(let n=0;n<39;n++){const a=document.createElementNS(e,"text");a.setAttributeNS(null,"x",16*n),a.setAttributeNS(null,"y",20*r+20),a.setAttributeNS(null,"fill","_000");const s=document.createTextNode("");a.appendChild(s),t.appendChild(a),this._textNodes[39*r+n]={node:s,char:" ",fill:"_000"}}this._canvas.insertAdjacentElement("afterend",t)}_renderFrame(){for(let e=0;e<this._rects.length;e++){const t=this._rects[e];this._ctx.fillStyle=t.colour,this._ctx.fillRect(t.x,t.y,t.w,t.h)}if(this._rects.length=0,this._waveUpdated&&(this._ctx.fillStyle=this._backgroundColour,this._ctx.fillRect(0,0,320,21),this._waveOn)){this._ctx.fillStyle=this._waveColour;for(let e=0;e<this._waveData.length;e++){const t=Math.min(this._waveData[e],20);this._ctx.fillRect(e,t,1,1)}}this._waveUpdated=!1;for(const[e,t]of Object.entries(this._textUpdates)){const e=t.node;t.char!==e.char&&(e.node.nodeValue=t.char,e.char=t.char),t.fill!==e.fill&&(e.node.parentElement.setAttributeNS(null,"fill",t.fill),e.fill=t.fill)}this._textUpdates={},this._frameQueued=!1}_queueFrame(){this._frameQueued||(requestAnimationFrame((()=>this._renderFrame())),this._frameQueued=!0)}drawRect(e,t,r,n,a,s,o){const i=`rgb(${a}, ${s}, ${o})`;0===e&&0===t&&320===r&&240===n&&(this._rects.length=0,this._backgroundColour=i,this._onBackgroundChanged(a,s,o)),this._rects.push({colour:i,x:e,y:t,w:r,h:n}),this._queueFrame()}drawText(e,t,r,n,a,s){const o=39*Math.floor(r/10)+Math.floor(t/8);this._textNodes[o]&&(this._textUpdates[o]={node:this._textNodes[o],char:e,fill:`rgb(${n}, ${a}, ${s})`},this._queueFrame())}drawWave(e,t,r,n){this._waveColour=`rgb(${e}, ${t}, ${r})`,320==n.length?(this._waveData.set(n),this._waveOn=!0,this._waveUpdated=!0,this._queueFrame()):this._waveOn&&(this._waveOn=!1,this._waveUpdated=!0,this._queueFrame())}clear(){this._rects=[{colour:this._backgroundColour,x:0,y:0,w:320,h:240}],this._waveOn=!1,this._waveUpdated=!0,this._textUpdates={};for(let e=0;e<this._textNodes.length;e++)this._textUpdates[e]={node:this._textNodes[e],char:" ",fill:"rgb(0, 0, 0)"};this._queueFrame()}}const textVert="#version 300 es\n\nlayout(location = 0) in vec3 colour;\nlayout(location = 1) in float char;\n\nout vec3 colourV;\nout vec2 fontCoord;\n\nconst vec2 corners[] = vec2[](\n    vec2(0, 0),\n    vec2(0, 1),\n    vec2(1, 0),\n    vec2(1, 1));\n\nconst vec2 camScale = vec2(2.0 / 320.0, -2.0 / 240.0);\nconst vec2 camOffset = vec2(-160.0, -120.0);\nconst vec2 size = vec2(5.0, 7.0);\n\nvoid main() {\n    float row;\n    float col = modf(float(gl_InstanceID) / 40.0, row) * 40.0;\n\n    vec2 pos = vec2(col, row) * vec2(8.0, 10.0) + vec2(0.0, 3.0);\n\n    pos = ((corners[gl_VertexID] * size + pos) + camOffset) * camScale;\n\n    gl_Position = vec4(char == 0.0 ? vec2(2.0) : pos, 0.0, 1.0);\n    colourV = colour;\n    fontCoord = (vec2(char - 1.0, 0.0) + corners[gl_VertexID]) * vec2(5.0, 7.0);\n}\n",textFrag="#version 300 es\nprecision highp float;\n\nuniform sampler2D font;\n\nin vec2 fontCoord;\nin vec3 colourV;\n\nout vec4 fragColour;\n\nvoid main() {\n    vec4 fontTexel = texelFetch(font, ivec2(fontCoord), 0);\n    fragColour = vec4(colourV, fontTexel.r);\n}\n",rectVert="#version 300 es\n\nlayout(location = 0) in vec4 shape;\nlayout(location = 1) in vec3 colour;\n\nout vec3 colourV;\n\nconst vec2 corners[] = vec2[](\n    vec2(0, 0),\n    vec2(0, 1),\n    vec2(1, 0),\n    vec2(1, 1));\n\nconst vec2 camScale = vec2(2.0 / 320.0, -2.0 / 240.0);\nconst vec2 camOffset = vec2(-160.0, -120.0);\n\nvoid main() {\n    vec2 pos = shape.xy;\n    vec2 size = shape.zw;\n    pos = ((corners[gl_VertexID] * size + pos) + camOffset) * camScale;\n\n    gl_Position = vec4(pos, 0.0, 1.0);\n    colourV = colour;\n}\n",rectFrag="#version 300 es\nprecision highp float;\n\nin vec3 colourV;\n\nout vec4 fragColour;\n\nvoid main() {\n    fragColour = vec4(colourV, 1.0);\n}\n",blitVert="#version 300 es\n\nout vec2 srcCoord;\n\nconst vec2 corners[] = vec2[](\n    vec2(0, 0),\n    vec2(0, 1),\n    vec2(1, 0),\n    vec2(1, 1));\n\nvoid main() {\n    vec2 pos = corners[gl_VertexID] * vec2(2.0, 2.0) + vec2(-1.0, -1.0);\n    gl_Position = vec4(pos, 0.0, 1.0);\n    srcCoord = corners[gl_VertexID] * vec2(320.0, 240.0);\n}\n",blitFrag="#version 300 es\nprecision highp float;\n\nuniform sampler2D src;\n\nin vec2 srcCoord;\n\nout vec4 fragColour;\n\nvoid main() {\n    fragColour = texelFetch(src, ivec2(srcCoord), 0);\n}\n",waveVert="#version 300 es\n\nlayout(location = 0) in uint value;\n\nconst vec2 camScale = vec2(2.0 / 320.0, -2.0 / 240.0);\nconst vec2 camOffset = vec2(-160.0, -120.0);\n\nvoid main() {\n    vec2 pos = vec2(float(gl_VertexID), float(value));\n    pos = (pos + vec2(0.5) + camOffset) * camScale;\n\n    gl_PointSize = 1.0;\n    gl_Position = vec4(pos, 0.0, 1.0);\n}\n",waveFrag="#version 300 es\nprecision highp float;\n\nuniform vec3 colour;\n\nout vec4 fragColour;\n\nvoid main() {\n    fragColour = vec4(colour, 1.0);\n}\n";var Shaders=Object.freeze({__proto__:null,textVert:textVert,textFrag:textFrag,rectVert:rectVert,rectFrag:rectFrag,blitVert:blitVert,blitFrag:blitFrag,waveVert:waveVert,waveFrag:waveFrag});const font="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdYAAAAHAQMAAACPwf4nAAAABlBMVEUAAAD///+l2Z/dAAABfklEQVQY0z2QsUsCcRTHn3rQL1G4MwSD4F52UDT1g6AlTr0GbQiKENoqxEFocRIryMThgiMJkhZNtCZr6U8I9HAoUYjGbKrRavEs67o7qO/wpvf5ft/3gT8TnMsiAARedV7XNQBbK1XqfXe0GGk8pcqaSvP3DpYBUwj/YiQAf2HYzHkyABSXfEEqA/qpEvNJFOPuF6psRVQqL9tmGAbYiT/O2AYSEgADK6sMRwDWLfaIhNkFZdsncZhwPlrsrCwfAhyc96feMOYedPe6mnqTb4Y2AL0fAuMpjkBhWteHmxpkSFSv8Ls8JklLzBcjqpAmIQDDrypi3KlSBWW1JueMm1GMPjAsAdu4YGfrJwTC7JmZmxQSRJ27zkZqNSeZNFlef8e0yYqyemn5gXfQZFgI2jmLHSWIrNVXiBvsqRS5SroIZ+UiNXPFoV02/ULm64LzdmN4eP2HH5aJ0fw4X+rddr4utEZ7Zz/sof27Mcez0bfSSVU/G23XYopb69cl+AW0nopO+Ne2hgAAAABJRU5ErkJggg==",MAX_RECTS=1024;class Renderer$1{_canvas;_gl;_bg=[0,0,0];_frameQueued=!1;_onBackgroundChanged;constructor(e,t){this._bg=[e[0]/255,e[1]/255,e[2]/255],this._onBackgroundChanged=t,this._canvas=document.getElementById("canvas"),this._gl=this._canvas.getContext("webgl2",{alpha:!1,antialias:!1});const r=this._gl;this._setupRects(r),this._setupText(r),this._setupWave(r),r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),r.viewport(0,0,320,240),this._queueFrame()}_rectShader;_rectVao;_rectShapes=new Uint16Array(4096);_rectColours=new Uint8Array(3072);_rectCount=0;_rectsClear=!0;_rectsTex;_rectsFramebuffer;_blitShader;_setupRects(e){this._rectShader=buildProgram(e,"rect"),this._rectVao=e.createVertexArray(),e.bindVertexArray(this._rectVao),this._rectShapes.glBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._rectShapes.glBuffer),e.bufferData(e.ARRAY_BUFFER,this._rectShapes,e.DYNAMIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,4,e.UNSIGNED_SHORT,!1,0,0),e.vertexAttribDivisor(0,1),this._rectColours.glBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._rectColours.glBuffer),e.bufferData(e.ARRAY_BUFFER,this._rectColours,e.DYNAMIC_DRAW),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,3,e.UNSIGNED_BYTE,!0,0,0),e.vertexAttribDivisor(1,1),this._rectsTex=e.createTexture(),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this._rectsTex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,320,240,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),this._rectsFramebuffer=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._rectsFramebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this._rectsTex,0),this._blitShader=buildProgram(e,"blit"),e.useProgram(this._blitShader),e.uniform1i(e.getUniformLocation(this._blitShader,"src"),0)}_renderRects(e){this._rectsClear&&(e.bindFramebuffer(e.FRAMEBUFFER,this._rectsFramebuffer),e.clearColor(this._bg[0],this._bg[1],this._bg[2],1),e.clear(e.COLOR_BUFFER_BIT),this._rectsClear=!1),this._rectCount>0&&(e.bindFramebuffer(e.FRAMEBUFFER,this._rectsFramebuffer),e.useProgram(this._rectShader),e.bindVertexArray(this._rectVao),e.bindBuffer(e.ARRAY_BUFFER,this._rectShapes.glBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._rectShapes,0,4*this._rectCount),e.bindBuffer(e.ARRAY_BUFFER,this._rectColours.glBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._rectColours,0,3*this._rectCount),e.drawArraysInstanced(e.TRIANGLE_STRIP,0,4,this._rectCount),this._rectCount=0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.useProgram(this._blitShader),e.drawArrays(e.TRIANGLE_STRIP,0,4)}drawRect(e,t,r,n,a,s,o){if(0===e&&0===t&&320===r&&240===n)this._onBackgroundChanged(a,s,o),this._bg=[a/255,s/255,o/255],this._rectCount=0,this._rectsClear=!0;else if(this._rectCount<1024){const i=this._rectCount;this._rectShapes[4*i+0]=e,this._rectShapes[4*i+1]=t,this._rectShapes[4*i+2]=r,this._rectShapes[4*i+3]=n,this._rectColours[3*i+0]=a,this._rectColours[3*i+1]=s,this._rectColours[3*i+2]=o,this._rectCount++}else console.warn("Out of rects!");this._queueFrame()}_textShader;_textVao;_textTex;_textColours=new Uint8Array(2880);_textChars=new Uint8Array(960);_setupText(e){this._textShader=buildProgram(e,"text"),e.useProgram(this._textShader),e.uniform1i(e.getUniformLocation(this._textShader,"font"),1),this._textVao=e.createVertexArray(),e.bindVertexArray(this._textVao),this._textColours.glBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._textColours.glBuffer),e.bufferData(e.ARRAY_BUFFER,this._textColours,e.DYNAMIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,3,e.UNSIGNED_BYTE,!0,0,0),e.vertexAttribDivisor(0,1),this._textChars.glBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._textChars.glBuffer),e.bufferData(e.ARRAY_BUFFER,this._textChars,e.DYNAMIC_DRAW),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,1,e.UNSIGNED_BYTE,!1,0,0),e.vertexAttribDivisor(1,1),this._textTex=e.createTexture(),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this._textTex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,470,7,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST);const t=new Image;t.onload=()=>{e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this._textTex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,470,7,0,e.RGBA,e.UNSIGNED_BYTE,t),this._queueFrame()},t.src=font}_renderText(e){e.useProgram(this._textShader),e.bindVertexArray(this._textVao),this._textColours.updated&&(e.bindBuffer(e.ARRAY_BUFFER,this._textColours.glBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._textColours),this._textColours.updated=!1),this._textChars.updated&&(e.bindBuffer(e.ARRAY_BUFFER,this._textChars.glBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._textChars),this._textChars.updated=!1),e.drawArraysInstanced(e.TRIANGLE_STRIP,0,4,960)}drawText(e,t,r,n,a,s){const o=40*Math.floor(r/10)+Math.floor(t/8);this._textChars[o]=e.charCodeAt(0)-32,this._textChars.updated=!0,this._textColours[3*o+0]=n,this._textColours[3*o+1]=a,this._textColours[3*o+2]=s,this._textColours.updated=!0,this._queueFrame()}_waveData=new Uint8Array(320);_waveColour=new Float32Array([.5,1,1]);_waveOn=!1;_setupWave(e){this._waveShader=buildProgram(e,"wave"),this._waveShader.colourUniform=e.getUniformLocation(this._waveShader,"colour"),this._waveVao=e.createVertexArray(),e.bindVertexArray(this._waveVao),this._waveData.glBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._waveData.glBuffer),e.bufferData(e.ARRAY_BUFFER,this._waveData,e.DYNAMIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribIPointer(0,1,e.UNSIGNED_BYTE,1,0)}_renderWave(e){this._waveOn&&(e.useProgram(this._waveShader),e.uniform3fv(this._waveShader.colourUniform,this._waveColour),e.bindVertexArray(this._waveVao),this._waveData.updated&&(e.bindBuffer(e.ARRAY_BUFFER,this._waveData.glBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._waveData),this._waveData.updated=!1),e.drawArrays(e.POINTS,0,320))}drawWave(e,t,r,n){this._waveColour[0]=e/255,this._waveColour[1]=t/255,this._waveColour[2]=r/255,320==n.length?(this._waveData.set(n),this._waveData.updated=!0,this._waveOn=!0,this._queueFrame()):this._waveOn&&(this._waveOn=!1,this._queueFrame())}_randomData(){for(let e=0;e<10;e++)this.drawRect(rand(0,300),rand(0,220),rand(5,25),rand(5,25),rand(0,255),rand(0,255),rand(0,255));for(let e=0;e<320;e+=8)for(let t=0;t<240;t+=10)this.drawText(String.fromCharCode(rand(20,126)),e,t,rand(0,255),rand(0,255),rand(0,255));this.drawWave(rand(0,255),rand(0,255),rand(0,255),new Uint8Array(Array(320).fill().map((()=>rand(0,20)))))}_renderFrame(){const e=this._gl;this._renderRects(e),this._renderText(e),this._renderWave(e),this._frameQueued=!1}_queueFrame(){this._frameQueued||(requestAnimationFrame((()=>this._renderFrame())),this._frameQueued=!0)}clear(){this._rectsClear=!0,this._rectCount=0,this._textChars.fill(0),this._textChars.updated=!0,this._waveOn=!1,this._queueFrame()}}function compileShader(e,t,r){const n=e.createShader(r);if(e.shaderSource(n,Shaders[t]),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS))throw new Error(`Failed to compile shader (${t}): ${e.getShaderInfoLog(n)}`);return n}function linkProgram(e,t,r,n){const a=e.createProgram();if(e.attachShader(a,r),e.attachShader(a,n),e.linkProgram(a),!e.getProgramParameter(a,e.LINK_STATUS))throw new Error(`Failed to link program (${t}): ${e.getProgramInfoLog(a)}`);return a}function buildProgram(e,t){return linkProgram(e,t,compileShader(e,`${t}Vert`,e.VERTEX_SHADER),compileShader(e,`${t}Frag`,e.FRAGMENT_SHADER))}function rand(e,t){return e+Math.floor(Math.random()*(t-e))}const updateInterval=18e5;let reloading=!1;function reload(){reloading||(window.location.reload(),reloading=!0)}let connection,reloadAction=()=>{};async function setup(){navigator.serviceWorker.addEventListener("controllerchange",(()=>reload()));let e=!navigator.serviceWorker.controller;const t=await navigator.serviceWorker.register("worker.js");t.addEventListener("updatefound",(()=>{if(e)return void(e=!1);const r=t.installing;r.addEventListener("statechange",(()=>{"installed"===r.state&&(reloadAction=navigator.serviceWorker.controller?()=>r.postMessage({action:"skipWaiting"}):reload,show("#reload"))}))})),setInterval((()=>t.update()),18e5)}document.querySelector("#reload button").addEventListener("click",(()=>reloadAction()));let keyState=0;const keyBitMap={up:6,down:5,left:7,right:2,select:4,start:3,option:1,edit:0},keyMap={ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right",ShiftLeft:"select",Space:"start",KeyZ:"option",KeyX:"edit"};function updateKeys(e,t,r){if(!e)return;r.preventDefault();const n=keyBitMap[e];if(void 0===n)return;"rect"===r.target.tagName&&r.target.classList.toggle("active",t);const a=t?keyState|1<<n:keyState&~(1<<n);a!==keyState&&(keyState=a,connection.sendKeys(keyState))}function setup$1(e){connection=e,document.addEventListener("keydown",(e=>updateKeys(keyMap[e.code],!0,e))),document.addEventListener("keyup",(e=>updateKeys(keyMap[e.code],!1,e)));const t=document.getElementById("controls");t.addEventListener("mousedown",(e=>updateKeys(e.target.dataset.key,!0,e))),t.addEventListener("touchstart",(e=>updateKeys(e.target.dataset.key,!0,e))),t.addEventListener("mouseup",(e=>updateKeys(e.target.dataset.key,!1,e))),t.addEventListener("touchend",(e=>updateKeys(e.target.dataset.key,!1,e)))}let ctx,displayType,onFullscreen,bg,enabled=!0;async function start(e=1){if(!ctx&&enabled){try{let t;for(ctx=new AudioContext,await navigator.mediaDevices.getUserMedia({audio:!0});t=await findDeviceId(),!t&&--e>0;)await wait(300);if(!t)throw new Error("M8 not found");const r=await navigator.mediaDevices.getUserMedia({audio:{deviceId:{exact:t},autoGainControl:!1,echoCancellation:!1,noiseSuppression:!1}});ctx.createMediaStreamSource(r).connect(ctx.destination),"running"!==ctx.state&&waitForUserGesture()}catch(e){console.error(e),stop()}enabled||stop()}}async function findDeviceId(){return(await navigator.mediaDevices.enumerateDevices()).filter((e=>"audioinput"===e.kind&&/M8/.test(e.label)&&"default"!==e.deviceId&&"communications"!==e.deviceId)).map((e=>e.deviceId))[0]}async function stop(){ctx&&await ctx.close().catch((()=>{})),ctx=null}function waitForUserGesture(){const e=["keydown","mousedown","touchstart"];function t(){ctx&&ctx.resume(),e.forEach((e=>document.removeEventListener(e,t)))}e.forEach((e=>document.addEventListener(e,t)))}function enable(){enabled||(enabled=!0,start())}function disable(){enabled=!1,stop()}function setOnFullscreen(e){onFullscreen=e}function setupToggle(e,t,r,n){const a=document.getElementById(e);a.addEventListener("change",(()=>{a.checked?(n(!0),save(t,!0)):(n(!1),save(t,!1))}));const s=get(t,r);a.checked=s,n(s)}function setupSelect(e,t,r,n){const a=document.getElementById(e);a.addEventListener("change",(()=>{n(a.value),save(t,a.value)}));const s=get(t,r);a.value=s,n(s)}function setupButton(e,t){document.getElementById(e).addEventListener("click",(()=>{t()}))}function get(e,t){const r=localStorage[e];return void 0===r?t:JSON.parse(r)}function save(e,t){localStorage[e]=JSON.stringify(t)}function onBackgroundChanged(e,t,r){const n=`rgb(${e}, ${t}, ${r})`;document.body.style.backgroundColor=n,document.documentElement.style.backgroundColor=n,localStorage.background=JSON.stringify([e,t,r])}document.querySelector("#settings .control").addEventListener("click",(e=>toggle("#settings"))),document.getElementById("settings").addEventListener("click",(e=>{"settings"===e.target.id&&hide("#settings")})),setupToggle("show-controls-setting","showControls",!0,(e=>document.getElementById("display").classList.toggle("with-controls",e))),setupToggle("enable-audio-setting","enableAudio",!0,(e=>{e?enable():disable()})),setupSelect("display-type-setting","displayType","webgl2",(e=>{displayType=e})),setupButton("go-fullscreen",(()=>{hide("#settings"),document.fullscreenElement?document.exitFullscreen():onFullscreen&&onFullscreen()})),localStorage.background?(bg=JSON.parse(localStorage.background),onBackgroundChanged(bg[0],bg[1],bg[2])):bg=[0,0,0];const renderer="webgl2"===displayType?new Renderer$1(bg,onBackgroundChanged):new Renderer(bg,onBackgroundChanged),parser=new Parser(renderer);function updateDisplay(e){e?(hide("#buttons, #display .error"),start(10)):(renderer.clear(),show("#buttons"),stop())}function goFullscreen(){document.body.requestFullscreen()}if(document.getElementById("display").addEventListener("dblclick",goFullscreen),setOnFullscreen(goFullscreen),navigator.serial){const e=new SerialConnection(parser,updateDisplay);setup$1(e);const t=document.createElement("button");t.innerText="Connect with Serial",document.getElementById("buttons").append(t),t.addEventListener("click",(()=>e.connect().catch((()=>show("#serial-fail"))))),window.addEventListener("beforeunload",(t=>e.disconnect())),e.connect(!0).catch((()=>{}))}else if(navigator.usb){const e=new UsbConnection(parser,updateDisplay);setup$1(e);const t=document.createElement("button");t.innerText="Connect with WebUSB",document.getElementById("buttons").append(t),t.addEventListener("click",(()=>e.connect().catch((()=>show("#usb-fail"))))),show("#buttons")}else document.getElementById("no-serial-usb").classList.remove("hidden");setup();

</script>
</body>
</html>
