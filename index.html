<!DOCTYPE html>
<!--
    Copyright 2021 James Deery
    Released under the MIT licence, https://opensource.org/licenses/MIT
 -->
<html>
<head>
    <title>M8 Display</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/png" href="icon.png">
    <link rel="manifest" href="app.webmanifest">
    <style>
@font-face{font-family:"stealth57";src:url("data:font/woff2;base64,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") format("woff2")}body{font-family:sans-serif;background-color:#111;color:#eee;margin:10px;font-size:16px}a,a:visited{color:#0ef}.hidden{display:none}#info{margin-top:-10px;text-align:center;padding:5px}#display{position:relative;height:480px;width:640px;margin:0 auto;user-select:none}#display canvas{image-rendering:pixelated}#display canvas,#display #svg{position:absolute;width:640px;height:480px;top:0px;left:0px}#display #svg text{font-family:"stealth57";font-size:16px}#display #buttons{position:relative;top:25px;text-align:center}#display #buttons button{font-family:stealth57;border:3px solid #fff;border-radius:10px;padding:20px;background-color:#999;color:#fff}#display #buttons button:active{background-color:#777}#display #buttons button:focus{border-style:dashed;outline:0}#display .error{position:absolute;top:100px;left:100px;right:100px;border:3px solid #fff;border-radius:10px;padding:20px;background-color:#a22;user-select:text}#display .error p{margin-top:0}#display .error p:last-child{margin-bottom:0}#controls{position:relative;width:640px;margin:0 auto}#controls rect{fill:#333;rx:10px;stroke:#aaa;stroke-width:3px}#reload{position:fixed;bottom:0;left:0;right:0;text-align:center}#reload button{border:3px solid #fff;border-radius:10px 10px 0 0;border-bottom-width:0;padding:20px;background-color:#55a;color:#fff;font-size:16px}#reload button:active{background-color:#338}#reload button:focus{border-style:dashed;outline:0}

</style>
    <style>
    </style>
</head>
<body>
    <div id="info">
        Work in progress, use at your own risk.
        More details at <a href="https://github.com/derkyjadex/M8WebDisplay">https://github.com/derkyjadex/M8WebDisplay</a>.
    </div>

    <div id="display">
        <canvas id="canvas" width="320" height="240"></canvas>
        <svg id="svg" width="320" height="240"/>

        <div id="serial-fail" class="error hidden">
            <p>Failed to connect over Serial.
            Are you sure your Teensy is connected and the M8 Headless firmware is loaded?</p>
            <p>Make sure that there are no other programs running which may have the serial port open.</p>
            <p>It is also possible there's a bug in this code.
            There may be some messages in the developer console that will help with debugging.
        </p></div>
        <div id="usb-fail" class="error hidden">
            <p>Failed to connect with WebUSB.
            Are you sure your Teensy is connected and the M8 Headless firmware is loaded?</p>
            <p>Connecting with WebUSB is known not to work on Windows or Linux.
            If you are using Chrome you can use Serial instead but you need to enable an experimental flag by going to <code>chrome://flags</code> and enabling "Experimental Web Platform features".</p>
        </div>
        <div id="no-serial-usb" class="error hidden">
            <p>Your browser doesn't appear to have Serial or WebUSB support.
            These are only currently supported in Chrome and some Chrome-derived browsers.</p>
        </div>

        <div id="buttons" class="hidden"></div>
    </div>

    <div id="controls">
        <svg width="640" height="560">
            <rect data-key="edit" x="490" y="10" width="140" height="140"/>
            <rect data-key="option" x="330" y="10" width="140" height="140"/>
            <rect data-key="up" x="170" y="80" width="140" height="140"/>
            <rect data-key="left" x="10" y="240" width="140" height="140"/>
            <rect data-key="down" x="170" y="240" width="140" height="140"/>
            <rect data-key="right" x="330" y="240" width="140" height="140"/>
            <rect data-key="select" x="170" y="410" width="140" height="140"/>
            <rect data-key="start" x="330" y="410" width="140" height="140"/>
        </svg>
    </div>

    <div id="reload" class="hidden">
        <button>An update is available. Click to reload.</button>
    </div>

    <script>
function show(e){document.querySelectorAll(e).forEach((e=>e.classList.remove("hidden")))}function hide(e){document.querySelectorAll(e).forEach((e=>e.classList.add("hidden")))}function wait(e){return new Promise((t=>setTimeout(t,e)))}class UsbConnection{_device;_parser;_onConnectionChanged;constructor(e,t){this._parser=e,this._onConnectionChanged=t}get isConnected(){return!!this._device}async _startReading(){try{for(;this._device;){const e=await this._device.transferIn(3,512);"ok"!==e.status?this.disconnect():this._parser.process(new Uint8Array(e.data.buffer))}}catch(e){console.error(e),this.disconnect()}}async sendKeys(e){if(this._device)try{await this._device.transferOut(3,new Uint8Array([67,e]))}catch(e){console.error(e),this.disconnect()}}async _reset(){await this._device.transferOut(3,new Uint8Array([68])),await wait(50),this._parser.reset(),await this._device.transferOut(3,new Uint8Array([69,82]))}async disconnect(){const e=this._device;e&&(this._device=null,await e.close().catch((()=>{})),this._onConnectionChanged(!1))}async connect(){if(!this._device)try{const e=await navigator.usb.getDevices();this._device=e.filter((e=>5824===e.vendorId&&1162===e.productId))[0],this._device||(this._device=await navigator.usb.requestDevice({filters:[{vendorId:5824,productId:1162}]})),await this._device.open(),await this._device.selectConfiguration(1),await this._device.claimInterface(1),await this._device.controlTransferOut({requestType:"class",recipient:"interface",request:34,value:3,index:1}),await this._device.controlTransferOut({requestType:"class",recipient:"interface",request:32,value:0,index:1},new Uint8Array([128,37,0,0,0,0,8])),await this._reset(),this._startReading(),this._onConnectionChanged(!0)}catch(e){if(this.disconnect(e),e.code!==DOMException.NOT_FOUND_ERR)throw console.error(e),e}}deviceInfo(){const e=this._device.configuration.interfaces.flatMap((e=>e.alternates[0].endpoints.map((t=>({ifNum:e.interfaceNumber,class:e.alternates[0].interfaceClass,subClass:e.alternates[0].interfaceSubclass,protocol:e.alternates[0].interfaceProtocol,epNum:t.endpointNumber,epDir:t.direction,epType:t.type,epPacketSize:t.packetSize})))));console.table(e)}}class SerialConnection{_port;_parser;_onConnectionChanged;_waitingForUserSelection;constructor(e,t){this._parser=e,this._onConnectionChanged=t,this._waitingForUserSelection=!1,navigator.serial.addEventListener("connect",(e=>{this._waitingForUserSelection||this.connect().catch((()=>{}))}))}get isConnected(){return!!this._port}async _startReading(){try{for(;this._port;){const{value:e,done:t}=await this._port.reader.read();if(e)try{this._parser.process(e)}catch(e){console.error(e)}if(t)return}}catch(e){console.error(e),this.disconnect()}}async sendKeys(e){if(this._port&&this._port.writer)try{await this._port.writer.write(new Uint8Array([67,e]))}catch(e){console.error(e),this.disconnect()}}async _reset(){await this._port.writer.write(new Uint8Array([68])),await wait(50),this._parser.reset(),await this._port.writer.write(new Uint8Array([69,82]))}async disconnect(){const e=this._port;e&&(this._port=null,await e.writer.write(new Uint8Array([68])).catch((()=>{})),e.reader&&await e.reader.cancel().catch((()=>{})),await e.close().catch((()=>{})),this._onConnectionChanged(!1))}async connect(e=!1){if(!this._port)try{const t=await navigator.serial.getPorts();if(this._port=t.filter((e=>{const t=e.getInfo();return 5824===t.usbVendorId&&1162===t.usbProductId}))[0],this._port||(e?this._onConnectionChanged(!1):this._port=await this._requestPort()),!this._port)return;await this._port.open({baudRate:9600,dataBits:8,stopBits:1,parity:"none",bufferSize:512}),this._port.reader=await this._port.readable.getReader(),this._port.writer=await this._port.writable.getWriter(),await this._reset(),this._startReading(),this._onConnectionChanged(!0)}catch(e){throw console.error(e),this.disconnect(e),e}}async _requestPort(){this._waitingForUserSelection=!0;try{return await navigator.serial.requestPort({filters:[{usbVendorId:5824,usbProductId:1162}]})}catch(e){if(e.code!==DOMException.NOT_FOUND_ERR)throw e;return null}finally{this._waitingForUserSelection=!1}}}const NORMAL=Symbol("normal"),ESCAPE=Symbol("escape"),ERROR=Symbol("error");class Parser{_state=NORMAL;_buffer=[];_renderer;constructor(e){this._renderer=e}_processFrame(e){switch(e[0]){case 254:e.length>=12?this._renderer.drawRect(e[1]+256*e[2],e[3]+256*e[4],e[5]+256*e[6],e[7]+256*e[8],e[9],e[10],e[11]):console.log("Bad RECT frame");break;case 253:e.length>=9?this._renderer.drawText(String.fromCharCode(e[1]),e[2]+256*e[3],e[4]+256*e[5],e[6],e[7],e[8]):console.log("Bad TEXT frame");break;case 252:if(e.length>=4){const t=e.splice(0,4);this._renderer.drawWave(t[1],t[2],t[3],e)}else console.log("Bad WAVE frame");break;case 251:break;default:console.log("BAD FRAME")}}process(e){for(let t=0;t<e.length;t++){const r=e[t];switch(this._state){case NORMAL:switch(r){case 192:this._processFrame(this._buffer),this._buffer.length=0;break;case 219:this._state=ESCAPE;break;default:this._buffer.push(r)}break;case ESCAPE:switch(r){case 220:this._buffer.push(192),this._state=NORMAL;break;case 221:this._buffer.push(219),this._state=NORMAL;break;default:this._state=ERROR,console.log("Unexpected SLIP sequence")}break;case ERROR:switch(r){case 192:this._state=NORMAL,this._buffer.length=0,console.log("SLIP recovered")}}}}reset(){this._state=NORMAL,this._buffer.length=0}}class Renderer{_canvas=document.getElementById("canvas");_ctx=canvas.getContext("2d");_textNodes=[];_backgroundColour="rgb(0, 0, 0)";_frameQueued=!1;_rects=[];_waveColour="rgb(255, 255, 255)";_waveData=[];_textUpdates={};constructor(){this._buildText()}_buildText(){const e=document.getElementById("svg");for(;e.firstChild;)e.removeChild(e.lastChild);for(let t=0;t<25;t++)for(let r=0;r<39;r++){const n=document.createElementNS("http://www.w3.org/2000/svg","text");n.setAttributeNS(null,"x",16*r),n.setAttributeNS(null,"y",20*t+20),n.setAttributeNS(null,"fill","_000");const a=document.createTextNode("");n.appendChild(a),e.appendChild(n),this._textNodes[39*t+r]={node:a,char:" ",fill:"_000"}}}_renderFrame(){for(let e=0;e<this._rects.length;e++){const t=this._rects[e];this._ctx.fillStyle=t.colour,this._ctx.fillRect(t.x,t.y,t.w,t.h)}if(this._rects.length=0,this._waveUpdated){this._ctx.fillStyle=this._backgroundColour,this._ctx.fillRect(0,0,320,21),this._ctx.fillStyle=this._waveColour;for(let e=0;e<this._waveData.length;e++){const t=Math.min(this._waveData[e],20);this._ctx.fillRect(e,t,1,1)}}this._waveUpdated=!1;for(const[e,t]of Object.entries(this._textUpdates)){const e=t.node;t.char!==e.char&&(e.node.nodeValue=t.char,e.char=t.char),t.fill!==e.fill&&(e.node.parentElement.setAttributeNS(null,"fill",t.fill),e.fill=t.fill)}this._textUpdates={},this._frameQueued=!1}_queueFrame(){this._frameQueued||(requestAnimationFrame((()=>this._renderFrame())),this._frameQueued=!0)}drawRect(e,t,r,n,a,s,i){const o=`rgb(${a}, ${s}, ${i})`;0===e&&0===t&&320===r&&240===n&&(this._rects.length=0,this._backgroundColour=o,document.body.style.backgroundColor=o),this._rects.push({colour:o,x:e,y:t,w:r,h:n}),this._queueFrame()}drawText(e,t,r,n,a,s){const i=39*Math.floor(r/10)+Math.floor(t/8);this._textNodes[i]&&(this._textUpdates[i]={node:this._textNodes[i],char:e,fill:`rgb(${n}, ${a}, ${s})`},this._queueFrame())}drawWave(e,t,r,n){this._waveColour=`rgb(${e}, ${t}, ${r})`,(n.length>0||this._waveData.length>0)&&(this._waveData=n.slice(),this._waveUpdated=!0,this._queueFrame())}clear(){this._rects=[{colour:this._backgroundColour,x:0,y:0,w:320,h:240}],this._waveData=[],this._waveUpdated=!0,this._textUpdates={};for(let e=0;e<this._textNodes.length;e++)this._textUpdates[e]={node:this._textNodes[e],char:" ",fill:"rgb(0, 0, 0)"};this._queueFrame()}}const updateInterval=18e5;let reloading=!1;function reload(){reloading||(window.location.reload(),reloading=!0)}let connection,reloadAction=()=>{};async function setup(){navigator.serviceWorker.addEventListener("controllerchange",(()=>reload()));let e=!navigator.serviceWorker.controller;const t=await navigator.serviceWorker.register("worker.js");t.addEventListener("updatefound",(()=>{if(e)return void(e=!1);const r=t.installing;r.addEventListener("statechange",(()=>{"installed"===r.state&&(reloadAction=navigator.serviceWorker.controller?()=>r.postMessage({action:"skipWaiting"}):reload,show("#reload"))}))})),setInterval((()=>t.update()),18e5)}document.querySelector("#reload button").addEventListener("click",(()=>reloadAction()));let keyState=0;const keyBitMap={up:6,down:5,left:7,right:2,select:4,start:3,option:1,edit:0},keyMap={ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right",ShiftLeft:"select",Space:"start",KeyZ:"option",KeyX:"edit"};function updateKeys(e,t,r){if(!e)return;r.preventDefault();const n=keyBitMap[e];if(void 0===n)return;const a=t?keyState|1<<n:keyState&~(1<<n);a!==keyState&&(keyState=a,connection.sendKeys(keyState))}function setup$1(e){connection=e,document.addEventListener("keydown",(e=>updateKeys(keyMap[e.code],!0,e))),document.addEventListener("keyup",(e=>updateKeys(keyMap[e.code],!1,e)));const t=document.getElementById("controls");t.addEventListener("mousedown",(e=>updateKeys(e.target.dataset.key,!0,e))),t.addEventListener("touchstart",(e=>updateKeys(e.target.dataset.key,!0,e))),t.addEventListener("mouseup",(e=>updateKeys(e.target.dataset.key,!1,e))),t.addEventListener("touchend",(e=>updateKeys(e.target.dataset.key,!1,e)))}let ctx;async function start(e=1){if(!ctx)try{let t;for(ctx=new AudioContext,await navigator.mediaDevices.getUserMedia({audio:!0});t=await findDeviceId(),!t&&--e>0;)await wait(300);if(!t)throw new Error("M8 not found");const r=await navigator.mediaDevices.getUserMedia({audio:{deviceId:{exact:t},autoGainControl:!1,echoCancellation:!1,noiseSuppression:!1}});ctx.createMediaStreamSource(r).connect(ctx.destination),"running"!==ctx.state&&waitForUserGesture()}catch(e){console.error(e),stop()}}async function findDeviceId(){return(await navigator.mediaDevices.enumerateDevices()).filter((e=>"audioinput"===e.kind&&/M8/.test(e.label)&&"default"!==e.deviceId&&"communications"!==e.deviceId)).map((e=>e.deviceId))[0]}async function stop(){ctx&&await ctx.close().catch((()=>{})),ctx=null}function waitForUserGesture(){const e=["keydown","mousedown","touchstart"];function t(){ctx.resume(),e.forEach((e=>document.removeEventListener(e,t)))}e.forEach((e=>document.addEventListener(e,t)))}const renderer=new Renderer,parser=new Parser(renderer);function updateDisplay(e){e?(hide("#buttons, #display .error"),start(10)):(renderer.clear(),show("#buttons"),stop())}if(navigator.serial){const e=new SerialConnection(parser,updateDisplay);setup$1(e);const t=document.createElement("button");t.innerText="Connect with Serial",document.getElementById("buttons").append(t),t.addEventListener("click",(()=>e.connect().catch((()=>show("#serial-fail"))))),window.addEventListener("beforeunload",(t=>e.disconnect())),e.connect(!0).catch((()=>{}))}else if(navigator.usb){const e=new UsbConnection(parser,updateDisplay);setup$1(e);const t=document.createElement("button");t.innerText="Connect with WebUSB",document.getElementById("buttons").append(t),t.addEventListener("click",(()=>e.connect().catch((()=>show("#usb-fail"))))),show("#buttons")}else document.getElementById("no-serial-usb").classList.remove("hidden");setup();

</script>
</body>
</html>
